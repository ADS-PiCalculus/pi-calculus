"use strict";function suiteFromGist(t,n){var e={source:"gist",successful:!0,programs:{}},r,o=function(){if(e.successful===!0){e.url=r.html_url;var t;try{t=JSON.parse(r.files["default.json"].content)}catch(o){t={}}t["default"]&&t["default"]+".pi"in r.files&&(e["default"]=t["default"]),delete t["default"];for(var i in r.files)if(i.endsWith(".pi")){var a=i.slice(0,-3);if(e.programs[a]={name:a,sourceCode:r.files[i].content,options:$.extend({},t)},a+".json"in r.files)try{$.extend(e.programs[a].options,JSON.parse(r.files[a+".json"].content))}catch(o){console.log("Warning",o)}}var s=Object.keys(e.programs);s.length<1?(e.successful=!1,e.error="empty",e.reason="This suite is empty. A program suite must contain at least one program."):e["default"]||(e["default"]=Object.keys(e.programs)[0])}return n(e)};if("string"!=typeof t)return t.files?(r=t,e.source="stored-gist",e.description=r.description,o()):(e.error="Wrong parameters",n(e));e.id=t;var i=t.match(gistUrlPattern);i?t="https://api.github.com/gists/"+i[2]:t.startsWith("http")||(t="https://api.github.com/gists/"+t),$.ajax(t,{cache:!0,success:function(t){if(r=t,t.truncated===!0)return e.error="truncated",e.reason="The gist is too big",o();e.description=t.description;var n=0,i=0;for(var a in t.files)i++,t.files[a].truncated?$.ajax(t.files[a].raw_url,{success:function(t){return function(n){t.content=n,t.truncated=!1}}(t.files[a]),complete:function(t,r){return n++,n===i?(e.successful=e.successful&&"success"===r,o()):void 0}}):n++;return n===i?o():void 0},error:function(t,n,r){return e.successful=!1,e.error=n,e.reason=r,o()}})}function suiteSize(t){return Object.keys(t.programs).length}function createGistFromSuite(t,n,e){var r={description:t.description,"public":!1,files:{}};for(var o in t.programs)r.files[o+".pi"]={content:t.programs[o].sourceCode},$.isEmptyObject(t.programs[o].options)||(r.files[o+".json"]={content:JSON.stringify(t.programs[o].options)});return $.ajax({url:"https://api.github.com/gists",type:"POST",data:JSON.stringify(r),success:n,error:e}),r}var Channel=function(){function t(e,r){return this instanceof t?(this.name=e,this.global=r===!0,n[e]||(n[e]=0),this.unique=n[e],void n[e]++):new t(e,r)}var n={};return t.prototype.toPiCalc=function(){return this.global===!0?this.name:this.name+"_"+this.unique},t.prototype.is=function(t){return this===t},t.prototype.toString=function(){return this.name+"#"+this.unique},t}(),ProcCall=function(){function t(e,r,o){return this instanceof t?(this.proc_name=e,this.args=r||[],this.unique=n++,void(this.isHeir=o===!0)):new t(e,r,o)}var n=0;return t.prototype.toPiCalc=function(){return this.proc_name+"["+this.args.map(function(t){return t.toPiCalc()}).join(",")+"]"},t}(),Action=function(){function t(){return this instanceof t?void 0:new t}return t}(),Tau=function(){function t(n){return this instanceof t?void(this.continuation=n):new t(n)}return t.prototype=new Action,t.prototype.constructor=t,t.prototype.fire=function(){return this.continuation instanceof Function?this.continuation():void 0},t.prototype.toPiCalc=function(){return"\u03c4..."},t}(),Receive=function(){function t(n,e){return this instanceof t?(this.channel=n,this.continuation=e||function(){},void(this.arity=e.length)):new t(n,e)}return t.prototype=new Action,t.prototype.constructor=t,t.prototype.fire=function(t){return this.continuation instanceof Function?this.continuation.apply(null,t):void 0},t.prototype.toPiCalc=function(){for(var t=[],n=0;n<this.arity;n++)t.push("_");return this.channel.toPiCalc()+"?("+t.join(",")+")..."},t}(),Send=function(){function t(n,e,r){return this instanceof t?(this.channel=n,this.args=e||[],this.arity=this.args.length,void(this.continuation=r)):new t(n,e,r)}return t.prototype=new Action,t.prototype.constructor=t,t.prototype.fire=function(){return this.continuation instanceof Function?this.continuation():void 0},t.prototype.toPiCalc=function(){return this.channel.toPiCalc()+"!("+this.args.map(function(t){return t.toPiCalc()}).join(",")+")..."},t}(),Alt=function(){function t(n){return this instanceof t?void(this.alts=n||[]):new t(n)}return t.prototype.enabled_on=function(t,n){return this.waiting_on(t).length>0},t.prototype.waiting_on=function(t,n){return this.receiving_on(t).concat(this.sending_on(t))},t.prototype.receiving_on=function(t,n){return this.alts.filter(function(e){if(e instanceof Receive){var r=void 0==n||e.arity==n;return e.channel.is(t)&&r}return!1})},t.prototype.sending_on=function(t,n){return this.alts.filter(function(e){if(e instanceof Send){var r=void 0==n||e.arity==n;return e.channel.is(t)&&r}return!1})},t.prototype.taus=function(){return this.alts.filter(function(t){return t instanceof Tau})},t.prototype.toPiCalc=function(){return"("+this.alts.map(function(t){return t.toPiCalc()}).join(" + ")+")"},t}(),Zero=void 0,PiDefs=function(){function t(n){return this instanceof t?void(this.defs=n):new t(n)}return t.prototype.unfold=function(t){if(t.proc_name in this.defs){var n=this.defs[t.proc_name];return n.length!==t.args.length?Zero:n.apply(n,t.args)}return Zero},t}(),Config=function(){function t(n,e){return this instanceof t?(this.defs=n,this.names_index={},this.init=e,this.nodes=[],this.procsIndex=0,this.epoch=0,this.links=[],this.mergeCalls(e,{x:0,y:0}),void this.recomputeLinks()):new t(n,e)}function n(t){var n=60;return t+Math.random()*n-n/2}function e(t,n){return void 0!=t&&"x"in t&&"y"in t?void 0!=n&&"x"in n&&"y"in n?{x:(t.x+n.x)/2,y:(t.y+n.y)/2}:{x:t.x,y:t.y}:void 0}function r(t){for(var n=t.length,e,r;n;)r=Math.floor(Math.random()*n--),e=t[n],t[n]=t[r],t[r]=e;return t}t.prototype.mergeCalls=function(t,e){var r=[],o=[],i=this;return void 0==t?{names:[],procs:[]}:(e=e||{x:0,y:0},t.forEach(function(t){if(t){t.args.forEach(function(t){t in i.names_index||(i.names_index[t]={refCount:0,age:0},void 0!=e&&(t.x=n(e.x),t.y=n(e.y)),r.push(t)),i.names_index[t].refCount++});var a={call:t,body:i.defs.unfold(t),age:i.epoch};t.x&&t.y?(a.x=t.x,a.y=t.y,t.fixed&&(a.fixed=!0)):void 0!=e&&(a.x=n(e.x),a.y=n(e.y)),o.push(a)}}),this.nodes.unshift.apply(this.nodes,r),this.nodes.push.apply(this.nodes,o),this.procsIndex+=r.length,{names:r,procs:o})},t.prototype.addCalls=function(t){"string"==typeof t&&(t=t.split("|"));for(var n,e=[],r=0;r<t.length;r++)try{for(var o=t[r].trim().split("["),i=o[0],a=o[1].split("]")[0].split(",").map(function(t){return t.trim()}),s=this.getNames(),c=0;c<a.length;c++){var u=s.find(function(t){return t.toPiCalc()==a[c]});u?a[c]=u:(u=e.find(function(t){return t.name==a[c]}),u?a[c]=u:(a[c]=Channel(a[c]),e.push(a[c])))}t[r]=ProcCall(i,a)}catch(l){return console.log(l),!1}return this.mergeCalls(t,n),this.recomputeLinks(),!0},t.prototype.gcNames=function(){for(var t in this.names_index)this.names_index[t].refCount<=0&&delete this.names_index[t];for(var n=0;n<this.procsIndex;)this.nodes[n]in this.names_index?n++:(this.nodes.splice(n,1),this.procsIndex--)},t.prototype.redexes=function(){for(var t=this.procsIndex,n=[];t<this.nodes.length;){if(this.nodes[t].body){var e=this.nodes[t];n=n.concat(e.body.taus().map(function(n){return{type:"tau",index:t,action:n,process:e}}))}t++}for(var r=[],o=0;o<this.procsIndex;){for(var i=[],a=[],t=this.procsIndex;t<this.nodes.length;){if(this.nodes[t].body){var e=this.nodes[t],s=e.body.receiving_on(this.nodes[o]),c=e.body.sending_on(this.nodes[o]);s.forEach(function(n){a.push({index:t,action:n,process:e})}),c.forEach(function(n){i.push({index:t,action:n,process:e})})}t++}for(var u=0,l=!1;u<i.length;){for(var p=0;p<a.length;){var f=i[u],h=a[p];f.index!=h.index&&f.action.arity==h.action.arity&&(r.push({type:"comm",sender:f,receiver:h}),l=!0),p++}u++}l?this.names_index[this.nodes[o]].age++:this.names_index[this.nodes[o]].age=0,o++}return n.concat(r)};var o=function(t){return{pick:function(n){r(n);for(var e=t.epoch+1,o,i=n.length-1;i>=0;i--){var a;a="tau"==n[i].type?t.nodes[n[i].index].age:Math.min(t.nodes[n[i].sender.index].age,t.nodes[n[i].receiver.index].age),e>=a&&(e=a,o=i)}return void 0!=o?n[o]:void 0}}};return t.prototype.next=function(t){void 0==t&&(t=o(this));var n=this.redexes();if(n.length<=0)return!1;var e=t.pick(n);return void 0==e?!1:(this.makeReact(e),!0)},t.prototype.makeReact=function(n){if("tau"==n.type){var r=e(this.nodes[n.index]),o=n.action.fire();t.heritage(this.nodes[n.index],o),this.removeProc(n.index),this.mergeCalls(o,r)}else{var r=e(this.nodes[n.sender.index],this.nodes[n.receiver.index]),i=n.sender.action.fire(),a=n.receiver.action.fire(n.sender.action.args),s=n.sender.index,c=n.receiver.index;t.heritage(this.nodes[s],i),t.heritage(this.nodes[c],a),this.removeProc(s>c?s:c),this.removeProc(s>c?c:s),this.mergeCalls(i,r),this.mergeCalls(a,r)}return this.gcNames(),this.recomputeLinks(),this.epoch++,this},t.heritage=function(t,n){if(t&&n){var e=n.filter(function(t){return t.isHeir})[0];e&&(e.x=t.x,e.y=t.y,t.fixed&&(e.fixed=!0))}},t.prototype.removeProc=function(t){if(t>=this.nodes.length||t<this.procsIndex)return!1;var n=this.names_index;return this.nodes[t].call.args.forEach(function(t){n[t].refCount--}),this.nodes.splice(t,1),!0},t.prototype.getNames=function(){return this.nodes.slice(0,this.procsIndex)},t.prototype.getProcs=function(){return this.nodes.slice(this.procsIndex)},t.prototype.recomputeLinks=function(){var t=this.links;t.splice(0,this.links.length);for(var n=this.procsIndex;n<this.nodes.length;n++){var e=this.nodes[n];e.call.args.forEach(function(n){t.push({source:e,target:n})})}},t.prototype.toPiCalc=function(){var t="",n=this.getNames().filter(function(t){return t.global!==!0}),e=this.getProcs();return n.length>0&&(t+="\u03bd"+n.map(function(t){return t.toPiCalc()}).join(",")+"."),e.length>0?(e.length>1&&(t+="( "),t+=e.map(function(t){return t.call.toPiCalc()}).join(" | "),e.length>1&&(t+=" )")):t+="0",t},t}(),PiCalcSimulation=function(){function t(o,i,a){function s(t){return d[t]||(v++,d[t]=n(v)),d[t]}function c(t){d3.event.altKey&&d3.select(this).classed("fixed",t.fixed=!t.fixed)}function u(t){d3.select(this).classed("fixed",t.fixed=!0)}if(!(this instanceof t))return new t(o,i,a);var l=i.defs,p=i.init,f=Config(l,p);this.q=f,a=a||{};for(var h in e)e.hasOwnProperty(h)&&!a.hasOwnProperty(h)&&(a[h]=e[h]);this.options=a;var d={Ghost:"white"},v=0;for(var g in a.palette)d[g]=a.palette[g];for(var g in l.defs)s(g);var m=d3.layout.force().charge(-400).linkDistance(function(t){return t.target.global?100:30}).linkStrength(function(t){return t.target.global?.01:.9}).friction(.8).nodes(f.nodes).links(f.links);this.layout=function(){return m};var y=o;o=o.append("g"),o.append("g").attr("id","links"),o.append("g").attr("id","nodes"),o.append("g").attr("id","labels");var x=o.select("#links").selectAll(".link"),C=o.select("#nodes").selectAll(".node .name"),w=o.select("#nodes").selectAll(".node .seq"),A=o.select("#labels").selectAll(".lbl"),b=o.select("#labels").selectAll(".name-lbl"),P=d3.behavior.zoom().scaleExtent([-10,10]).translate([y.attr("width")/2,y.attr("height")/2]).on("zoom",function(){o.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")});y.call(P),this.translate=function(){return arguments.length>0?P.translate.apply(P,arguments).event(o):P.translate()},this.scale=function(){return arguments.length>0?P.scale.apply(P,arguments).event(o):P.scale()},this.zoom=function(){return P},this.legend=function(){var t=[];for(var n in d)"Ghost"!==n&&t.push({name:n,color:d[n]});return t};var _=m.drag().on("dragstart",function(){d3.event.sourceEvent.stopPropagation()});this.update=function(){x=x.data(f.links),C=C.data(f.getNames(),function(t){return t.toString()}),w=w.data(f.getProcs(),function(t){return t.call.unique}),A=A.data(f.getProcs(),function(t){return t.call.unique}),b=b.data(f.getNames(),function(t){return t.toString()}),x.exit().remove(),x.enter().append("line").classed("link",!0),x.classed("global",function(t){return t.target.global}),A.exit().remove(),A.enter().append("text").attr("class","lbl").text(function(t){return t.color=s(t.call.proc_name),"Ghost"===t.call.proc_name?"":t.call.proc_name}),b.exit().remove(),b.enter().append("text").attr("class","nlbl").classed("global",function(t){return t.global}).html(function(t){return t.toPiCalc().replace(r,'$1 <tspan dy=".3em" dx="-.9em" style="font-size:60%">$2</tspan>')}),C.exit().remove(),C.classed("fixed",function(t){return t.fixed}),C.enter().append("circle").classed({node:!0,name:!0}).classed("global",function(t){return t.global}).attr("r",a.nameSize).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).on("click",c).call(_).append("title").text(function(t){return t.toPiCalc()});var t=a.procWidth/2,n=a.procHeight/2;return w.exit().remove(),w.enter().append("rect").attr("class","node seq").attr("width",a.procWidth).attr("height",a.procHeight).attr("x",function(n){return n.x-t}).attr("y",function(t){return t.y-n}).classed("fixed",function(t){return t.fixed}).style("fill",function(t){return t.color}).on("click",function(t){console.info(t.call.toPiCalc(),t.x,t.y)}).on("click",c).call(_).append("title").text(function(t){return t.call.toPiCalc()}),m.start(),this};var z=void 0;this.init=function(t){return z=t,this};var k=function(t){return t.x},$=function(t){return t.y};m.on("tick",function(){var t=a.procWidth/2,n=a.procHeight/2,e=k,r=$;if(void 0!=a.collapse){var o;e=function(t){return t instanceof Channel&&t.name==a.collapse?(void 0==o&&(o=t),o.x):t.x},r=function(t){return t instanceof Channel&&t.name==a.collapse?(void 0==o&&(o=t),o.y):t.y}}x.attr("x1",function(t){return e(t.source)}).attr("y1",function(t){return r(t.source)}).attr("x2",function(t){return e(t.target)}).attr("y2",function(t){return r(t.target)}),C.attr("cx",e).attr("cy",r),A.attr("x",function(t){return e(t)}).attr("y",function(t){return r(t)-a.procHeight}),b.attr("x",function(t){return e(t)}).attr("y",function(t){return r(t)-a.nameSize-5}),w.attr("x",function(n){return n.x-t}).attr("y",function(t){return t.y-n}),z&&(z(),z=void 0)}),this.update(),P.event(o)}var n=d3.scale.category20(),e={nameSize:5,procWidth:18,procHeight:12},r=/^(.*)_(\d*)$/;return t.prototype.randomStrategy={pick:function(t){return t[Math.floor(Math.random()*t.length)]}},t.prototype.next=function(t){return this.q.next(t)?(this.update(),!0):!1},t}();window.parsePi=function(){function t(t,n){function e(){this.constructor=t}e.prototype=n.prototype,t.prototype=new e}function n(t,e,r,o){this.message=t,this.expected=e,this.found=r,this.location=o,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,n)}function e(t){function e(){return t.substring(ne,te)}function r(){return s(ne,te)}function o(n){throw u(null,[{type:"other",description:n}],t.substring(ne,te),s(ne,te))}function i(n){throw u(n,null,t.substring(ne,te),s(ne,te))}function a(n){var e=ee[n],r,o;if(e)return e;for(r=n-1;!ee[r];)r--;for(e=ee[r],e={line:e.line,column:e.column,seenCR:e.seenCR};n>r;)o=t.charAt(r),"\n"===o?(e.seenCR||e.line++,e.column=1,e.seenCR=!1):"\r"===o||"\u2028"===o||"\u2029"===o?(e.line++,e.column=1,e.seenCR=!0):(e.column++,e.seenCR=!1),r++;return ee[n]=e,e}function s(t,n){var e=a(t),r=a(n);return{start:{offset:t,line:e.line,column:e.column},end:{offset:n,line:r.line,column:r.column}}}function c(t){re>te||(te>re&&(re=te,oe=[]),oe.push(t))}function u(t,e,r,o){function i(t){var n=1;for(t.sort(function(t,n){return t.description<n.description?-1:t.description>n.description?1:0});n<t.length;)t[n-1]===t[n]?t.splice(n,1):n++}function a(t,n){function e(t){function n(t){return t.charCodeAt(0).toString(16).toUpperCase()}return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(t){return"\\x0"+n(t)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(t){return"\\x"+n(t)}).replace(/[\u0100-\u0FFF]/g,function(t){return"\\u0"+n(t)}).replace(/[\u1000-\uFFFF]/g,function(t){return"\\u"+n(t)})}var r=new Array(t.length),o,i,a;for(a=0;a<t.length;a++)r[a]=t[a].description;return o=t.length>1?r.slice(0,-1).join(", ")+" or "+r[t.length-1]:r[0],i=n?'"'+e(n)+'"':"end of input","Expected "+o+" but "+i+" found."}return null!==e&&i(e),new n(null!==t?t:a(e,r),e,r,o)}function l(){var t,n,e,r,o;return t=te,n=W(),n!==tt?(e=h(),e!==tt?(r=W(),r!==tt?(o=p(),o!==tt?(ne=t,n=rt(e,o),t=n):(te=t,t=tt)):(te=t,t=tt)):(te=t,t=tt)):(te=t,t=tt),t}function p(){var t,n,e,r,o;for(t=te,n=[],e=te,r=f(),r!==tt?(o=W(),o!==tt?(ne=e,r=ot(r),e=r):(te=e,e=tt)):(te=e,e=tt);e!==tt;)n.push(e),e=te,r=f(),r!==tt?(o=W(),o!==tt?(ne=e,r=ot(r),e=r):(te=e,e=tt)):(te=e,e=tt);return n!==tt&&(ne=t,n=it(n)),t=n}function f(){var n,e,r,o,i,a;return ie++,n=te,e=z(),e!==tt?(r=W(),r!==tt?(t.substr(te,2)===st?(o=st,te+=2):(o=tt,0===ie&&c(ct)),o!==tt?(i=W(),i!==tt?(a=h(),a!==tt?(ne=n,e=ut(e,a),n=e):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt),ie--,n===tt&&(e=tt,0===ie&&c(at)),n}function h(){var t,n,e,r,o,i,a,s;if(ie++,t=te,n=d(),n!==tt){for(e=[],r=te,o=W(),o!==tt?(i=O(),i!==tt?(a=W(),a!==tt?(s=d(),s!==tt?(ne=r,o=pt(n,s),r=o):(te=r,r=tt)):(te=r,r=tt)):(te=r,r=tt)):(te=r,r=tt);r!==tt;)e.push(r),r=te,o=W(),o!==tt?(i=O(),i!==tt?(a=W(),a!==tt?(s=d(),s!==tt?(ne=r,o=pt(n,s),r=o):(te=r,r=tt)):(te=r,r=tt)):(te=r,r=tt)):(te=r,r=tt);e!==tt?(ne=t,n=ft(n,e),t=n):(te=t,t=tt)}else te=t,t=tt;return ie--,t===tt&&(n=tt,0===ie&&c(lt)),t}function d(){var n,e,r,o,i,a;return ie++,n=G(),n===tt&&(n=v(),n===tt&&(n=te,e=k(),e!==tt&&(ne=n,e=ht(e)),n=e,n===tt&&(n=te,e=w(),e!==tt&&(ne=n,e=ht(e)),n=e,n===tt&&(n=te,40===t.charCodeAt(te)?(e=dt,te++):(e=tt,0===ie&&c(vt)),e!==tt?(r=W(),r!==tt?(o=h(),o!==tt?(i=W(),i!==tt?(41===t.charCodeAt(te)?(a=gt,te++):(a=tt,0===ie&&c(mt)),a!==tt?(ne=n,e=yt(o),n=e):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt),n===tt&&(n=te,e=g(),e!==tt&&(ne=n,e=xt(e)),n=e))))),ie--,n===tt&&(e=tt,0===ie&&c(lt)),n}function v(){var n,e,r;return ie++,n=te,64===t.charCodeAt(te)?(e=wt,te++):(e=tt,0===ie&&c(At)),e===tt&&(e=null),e!==tt?(r=z(),r!==tt?(ne=n,e=bt(e,r),n=e):(te=n,n=tt)):(te=n,n=tt),ie--,n===tt&&(e=tt,0===ie&&c(Ct)),n}function g(){var t,n,e,r,o,i,a,s;if(t=te,n=m(),n!==tt){for(e=[],r=te,o=W(),o!==tt?(i=T(),i!==tt?(a=W(),a!==tt?(s=m(),s!==tt?(ne=r,o=Pt(n,s),r=o):(te=r,r=tt)):(te=r,r=tt)):(te=r,r=tt)):(te=r,r=tt);r!==tt;)e.push(r),r=te,o=W(),o!==tt?(i=T(),i!==tt?(a=W(),a!==tt?(s=m(),s!==tt?(ne=r,o=Pt(n,s),r=o):(te=r,r=tt)):(te=r,r=tt)):(te=r,r=tt)):(te=r,r=tt);e!==tt?(ne=t,n=_t(n,e),t=n):(te=t,t=tt)}else te=t,t=tt;return t}function m(){var n,e,r,o,i,a,s;return ie++,n=te,e=A(),e!==tt?(r=W(),r!==tt?(o=te,46===t.charCodeAt(te)?(i=kt,te++):(i=tt,0===ie&&c($t)),i!==tt?(a=W(),a!==tt?(s=x(),s!==tt?(ne=o,i=St(e,s),o=i):(te=o,o=tt)):(te=o,o=tt)):(te=o,o=tt),o===tt&&(o=null),o!==tt?(ne=n,e=jt(e,o),n=e):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt),ie--,n===tt&&(e=tt,0===ie&&c(zt)),n}function y(){var t,n;return t=te,n=m(),n!==tt&&(ne=t,n=Et(n)),t=n}function x(){var t,n;return ie++,t=G(),t===tt&&(t=k(),t===tt&&(t=C())),ie--,t===tt&&(n=tt,0===ie&&c(It)),t}function C(){var n,e,r,o,i,a;return n=v(),n===tt&&(n=te,40===t.charCodeAt(te)?(e=dt,te++):(e=tt,0===ie&&c(vt)),e!==tt?(r=W(),r!==tt?(o=h(),o!==tt?(i=W(),i!==tt?(41===t.charCodeAt(te)?(a=gt,te++):(a=tt,0===ie&&c(mt)),a!==tt?(ne=n,e=yt(o),n=e):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt),n===tt&&(n=te,e=y(),e!==tt&&(ne=n,e=Nt(e)),n=e)),n}function w(){var n,e,r,o;return ie++,n=te,42===t.charCodeAt(te)?(e=Ft,te++):(e=tt,0===ie&&c(Ot)),e!==tt?(r=W(),r!==tt?(o=C(),o!==tt?(ne=n,e=Tt(o),n=e):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt),ie--,n===tt&&(e=tt,0===ie&&c(Rt)),n}function A(){var t,n;return ie++,t=P(),t===tt&&(t=b(),t===tt&&(t=_())),ie--,t===tt&&(n=tt,0===ie&&c(Lt)),t}function b(){var n,e,r,o,i,a,s,u;return ie++,n=te,e=R(),e!==tt?(r=W(),r!==tt?(40===t.charCodeAt(te)?(o=dt,te++):(o=tt,0===ie&&c(vt)),o!==tt?(i=W(),i!==tt?(a=j(),a===tt&&(a=null),a!==tt?(s=W(),s!==tt?(41===t.charCodeAt(te)?(u=gt,te++):(u=tt,0===ie&&c(mt)),u!==tt?(ne=n,e=qt(e,a),n=e):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt),ie--,n===tt&&(e=tt,0===ie&&c(Gt)),n}function P(){var n,e,r,o,i,a,s,u;return ie++,n=te,e=R(),e!==tt?(r=W(),r!==tt?(60===t.charCodeAt(te)?(o=Zt,te++):(o=tt,0===ie&&c(Ut)),o!==tt?(i=W(),i!==tt?(a=j(),a===tt&&(a=null),a!==tt?(s=W(),s!==tt?(62===t.charCodeAt(te)?(u=Ht,te++):(u=tt,0===ie&&c(Mt)),u!==tt?(ne=n,e=Bt(e,a),n=e):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt),ie--,n===tt&&(e=tt,0===ie&&c(Wt)),n}function _(){var t,n;return t=te,n=F(),n!==tt&&(ne=t,n=Dt()),t=n}function z(){var t,n,e,r;return t=te,n=N(),n!==tt?(e=W(),e!==tt?(r=S(),r===tt&&(r=null),r!==tt?(ne=t,n=Jt(n,r),t=n):(te=t,t=tt)):(te=t,t=tt)):(te=t,t=tt),t}function k(){var n,e,r,o,i,a,s,u;return ie++,n=te,e=L(),e!==tt?(r=W(),r!==tt?(o=$(),o!==tt?(i=W(),i!==tt?(46===t.charCodeAt(te)?(a=kt,te++):(a=tt,0===ie&&c($t)),a!==tt?(s=W(),s!==tt?(u=x(),u===tt&&(u=k()),u!==tt?(ne=n,e=Yt(o,u),n=e):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt),ie--,n===tt&&(e=tt,0===ie&&c(Kt)),n}function $(){var n,e,r,o,i,a;return n=te,40===t.charCodeAt(te)?(e=dt,te++):(e=tt,0===ie&&c(vt)),e!==tt?(r=W(),r!==tt?(o=E(),o!==tt?(i=W(),i!==tt?(41===t.charCodeAt(te)?(a=gt,te++):(a=tt,0===ie&&c(mt)),a!==tt?(ne=n,e=Qt(o),n=e):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt),n===tt&&(n=E()),n}function S(){var n,e,r,o,i,a;return ie++,n=te,91===t.charCodeAt(te)?(e=Xt,te++):(e=tt,0===ie&&c(tn)),e!==tt?(r=W(),r!==tt?(o=j(),o===tt&&(o=null),o!==tt?(i=W(),i!==tt?(93===t.charCodeAt(te)?(a=nn,te++):(a=tt,0===ie&&c(en)),a!==tt?(ne=n,e=rn(o),n=e):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt)):(te=n,n=tt),ie--,n===tt&&(e=tt,0===ie&&c(Vt)),n}function j(){var n,e,r,o,i,a,s,u;if(ie++,n=te,e=R(),e!==tt)if(r=W(),r!==tt){for(o=[],i=te,44===t.charCodeAt(te)?(a=an,te++):(a=tt,0===ie&&c(sn)),a!==tt?(s=W(),s!==tt?(u=R(),u!==tt?(ne=i,a=cn(e,u),i=a):(te=i,i=tt)):(te=i,i=tt)):(te=i,i=tt);i!==tt;)o.push(i),i=te,44===t.charCodeAt(te)?(a=an,te++):(a=tt,0===ie&&c(sn)),a!==tt?(s=W(),s!==tt?(u=R(),u!==tt?(ne=i,a=cn(e,u),i=a):(te=i,i=tt)):(te=i,i=tt)):(te=i,i=tt);o!==tt?(ne=n,e=un(e,o),n=e):(te=n,n=tt)}else te=n,n=tt;else te=n,n=tt;return ie--,n===tt&&(e=tt,0===ie&&c(on)),n}function E(){var n,e,r,o,i,a,s,u;if(ie++,n=te,e=I(),e!==tt)if(r=W(),r!==tt){for(o=[],i=te,44===t.charCodeAt(te)?(a=an,te++):(a=tt,0===ie&&c(sn)),a!==tt?(s=W(),s!==tt?(u=I(),u!==tt?(ne=i,a=cn(e,u),i=a):(te=i,i=tt)):(te=i,i=tt)):(te=i,i=tt);i!==tt;)o.push(i),i=te,44===t.charCodeAt(te)?(a=an,te++):(a=tt,0===ie&&c(sn)),a!==tt?(s=W(),s!==tt?(u=I(),u!==tt?(ne=i,a=cn(e,u),i=a):(te=i,i=tt)):(te=i,i=tt)):(te=i,i=tt);o!==tt?(ne=n,e=un(e,o),n=e):(te=n,n=tt)}else te=n,n=tt;else te=n,n=tt;return ie--,n===tt&&(e=tt,0===ie&&c(on)),n}function I(){var t,n;return t=te,n=R(),n!==tt&&(ne=t,n=ln(n)),t=n}function N(){var n,e,r,o,i;if(ie++,n=te,e=te,fn.test(t.charAt(te))?(r=t.charAt(te),te++):(r=tt,0===ie&&c(hn)),r!==tt){for(o=[],dn.test(t.charAt(te))?(i=t.charAt(te),te++):(i=tt,0===ie&&c(vn));i!==tt;)o.push(i),dn.test(t.charAt(te))?(i=t.charAt(te),te++):(i=tt,0===ie&&c(vn));o!==tt?(r=[r,o],e=r):(te=e,e=tt)}else te=e,e=tt;return n=e!==tt?t.substring(n,te):e,ie--,n===tt&&(e=tt,0===ie&&c(pn)),n}function R(){var n,e,r,o,i;if(ie++,n=te,e=te,mn.test(t.charAt(te))?(r=t.charAt(te),te++):(r=tt,0===ie&&c(yn)),r!==tt){for(o=[],dn.test(t.charAt(te))?(i=t.charAt(te),te++):(i=tt,0===ie&&c(vn));i!==tt;)o.push(i),dn.test(t.charAt(te))?(i=t.charAt(te),te++):(i=tt,0===ie&&c(vn));o!==tt?(r=[r,o],e=r):(te=e,e=tt)}else te=e,e=tt;return n=e!==tt?t.substring(n,te):e,ie--,n===tt&&(e=tt,0===ie&&c(gn)),n}function F(){var n;return t.substr(te,3)===xn?(n=xn,te+=3):(n=tt,0===ie&&c(Cn)),n===tt&&(964===t.charCodeAt(te)?(n=wn,te++):(n=tt,0===ie&&c(An))),n}function O(){var n;return 124===t.charCodeAt(te)?(n=bn,te++):(n=tt,0===ie&&c(Pn)),n===tt&&(8214===t.charCodeAt(te)?(n=_n,te++):(n=tt,0===ie&&c(zn))),n}function T(){var n;return 43===t.charCodeAt(te)?(n=kn,te++):(n=tt,0===ie&&c($n)),n}function L(){var n;return t.substr(te,3)===Sn?(n=Sn,te+=3):(n=tt,0===ie&&c(jn)),n===tt&&(957===t.charCodeAt(te)?(n=En,te++):(n=tt,0===ie&&c(In))),n}function G(){var t,n;return t=te,n=q(),n!==tt&&(ne=t,n=Nn()),t=n}function q(){var n;return t.substr(te,4)===Rn?(n=Rn,te+=4):(n=tt,0===ie&&c(Fn)),n===tt&&(48===t.charCodeAt(te)?(n=On,te++):(n=tt,0===ie&&c(Tn))),n}function W(){var t,n;for(t=[],n=U(),n===tt&&(n=H());n!==tt;)t.push(n),n=U(),n===tt&&(n=H());return t}function Z(){var n,e;for(ie++,n=[],Gn.test(t.charAt(te))?(e=t.charAt(te),te++):(e=tt,0===ie&&c(qn));e!==tt;)n.push(e),Gn.test(t.charAt(te))?(e=t.charAt(te),te++):(e=tt,0===ie&&c(qn));return ie--,n===tt&&(e=tt,0===ie&&c(Ln)),n}function U(){var n,e;return ie++,Gn.test(t.charAt(te))?(n=t.charAt(te),te++):(n=tt,0===ie&&c(qn)),ie--,n===tt&&(e=tt,0===ie&&c(Wn)),n}function H(){var n,e,r,o,i,a;if(ie++,n=te,t.substr(te,2)===Un?(e=Un,te+=2):(e=tt,0===ie&&c(Hn)),e!==tt){for(r=[],o=te,i=te,ie++,t.substr(te,2)===Mn?(a=Mn,te+=2):(a=tt,0===ie&&c(Bn)),ie--,a===tt?i=void 0:(te=i,i=tt),i!==tt?(t.length>te?(a=t.charAt(te),te++):(a=tt,0===ie&&c(Dn)),a!==tt?(i=[i,a],o=i):(te=o,o=tt)):(te=o,o=tt);o!==tt;)r.push(o),o=te,i=te,ie++,t.substr(te,2)===Mn?(a=Mn,te+=2):(a=tt,0===ie&&c(Bn)),ie--,a===tt?i=void 0:(te=i,i=tt),i!==tt?(t.length>te?(a=t.charAt(te),te++):(a=tt,0===ie&&c(Dn)),a!==tt?(i=[i,a],o=i):(te=o,o=tt)):(te=o,o=tt);r!==tt?(t.substr(te,2)===Mn?(o=Mn,te+=2):(o=tt,0===ie&&c(Bn)),o!==tt?(e=[e,r,o],n=e):(te=n,n=tt)):(te=n,n=tt)}else te=n,n=tt;if(n===tt)if(n=te,t.substr(te,2)===Jn?(e=Jn,te+=2):(e=tt,0===ie&&c(Kn)),e!==tt){for(r=[],Yn.test(t.charAt(te))?(o=t.charAt(te),te++):(o=tt,0===ie&&c(Qn));o!==tt;)r.push(o),Yn.test(t.charAt(te))?(o=t.charAt(te),te++):(o=tt,0===ie&&c(Qn));r!==tt?(10===t.charCodeAt(te)?(o=Vn,te++):(o=tt,0===ie&&c(Xn)),o===tt&&(o=null),o!==tt?(e=[e,r,o],n=e):(te=n,n=tt)):(te=n,n=tt)}else te=n,n=tt;return ie--,n===tt&&(e=tt,0===ie&&c(Zn)),n}function M(t){return null==t?[]:t}function B(t,n){return n.unshift(t),n}function D(t){return{type:"Parall",components:t}}function J(t){return{type:"Alt",components:t,loc:r()}}function K(t){return{type:"Bang",components:t,loc:r()}}function Y(t,n){return t.type!=n.type&&i("Merging uncompatible objects "+t.type+" and "+n.type),{type:t.type,components:t.components.concat(n.components)}}function Q(t,n){var e=t;for(var r in n)e=Y(e,n[r]);return e}var V=arguments.length>1?arguments[1]:{},X=this,tt={},nt={start:l},et=l,rt=function(t,n){return{start:t,defs:n}},ot=function(t){return t},it=function(t){for(var n={},e=0;e<t.length;e++){var r=t[e].pvar;r in n?i("Multiple definition for "+r):n[r]=t[e].def}return n},at={type:"other",description:"process definition"},st=":=",ct={type:"literal",value:":=",description:'":="'},ut=function(t,n){return("Parall"!==n.type||n.components.length>1)&&i("The top level of a definitions should be a sum"),0===n.components.length?n.type="Alt":(n=n.components[0],"Alt"!==n.type&&i("The top level of a definitions should be a sum")),{pvar:t.pvar,def:{args:t.args,body:n}}},lt={type:"other",description:"term"},pt=function(t,n){return n},ft=function(t,n){return Q(t,n)},ht=function(t){return D([t])},dt="(",vt={type:"literal",value:"(",description:'"("'},gt=")",mt={type:"literal",value:")",description:'")"'},yt=function(t){return t},xt=function(t){return D([t])},Ct={type:"other",description:"process call"},wt="@",At={type:"literal",value:"@",description:'"@"'},bt=function(t,n){return t&&(n.heir=!0),n.type="PiCall",D([n])},Pt=function(t,n){return n},_t=function(t,n){return J(B(t,n))},zt={type:"other",description:"factor"},kt=".",$t={type:"literal",value:".",description:'"."'},St=function(t,n){return n},jt=function(t,n){return null==n&&(n=D([])),{action:t,cont:n}},Et=function(t){return J([t])},It={type:"other",description:"continuation"},Nt=function(t){return D([t])},Rt={type:"other",description:"replicated process"},Ft="*",Ot={type:"literal",value:"*",description:'"*"'},Tt=function(t){1!=t.components.length&&i("Only guarded replication is supported!");var n=t.components[0];return"Alt"!=n.type&&i("Only guarded replication is supported!"),K(n.components)},Lt={type:"other",description:"action prefix"},Gt={type:"other",description:"input action"},qt=function(t,n){return{channel:t,type:"input",args:M(n),loc:r()}},Wt={type:"other",description:"output action"},Zt="<",Ut={type:"literal",value:"<",description:'"<"'},Ht=">",Mt={type:"literal",value:">",description:'">"'},Bt=function(t,n){return{channel:t,type:"output",args:M(n),loc:r()}},Dt=function(){return{type:"tau",loc:r()}},Jt=function(t,n){return{pvar:t,args:M(n),loc:r()}},Kt={type:"other",description:"restriction"},Yt=function(t,n){return 0==t.length?n:"New"==n.type?{type:"New",names:t.concat(n.names),proc:n.proc}:{type:"New",names:t,proc:n}},Qt=function(t){return t},Vt={type:"other",description:"arguments list"},Xt="[",tn={type:"literal",value:"[",description:'"["'},nn="]",en={type:"literal",value:"]",description:'"]"'},rn=function(t){return M(t)},on={type:"other",description:"list of names"},an=",",sn={type:"literal",value:",",description:'","'},cn=function(t,n){return n},un=function(t,n){return n.unshift(t),n},ln=function(t){return{name:t,loc:r()}},pn={type:"other",description:"process identifier"},fn=/^[A-Z]/,hn={type:"class",value:"[A-Z]",description:"[A-Z]"},dn=/^[a-zA-Z0-9'_]/,vn={type:"class",value:"[a-zA-Z0-9'_]",description:"[a-zA-Z0-9'_]"},gn={type:"other",description:"name"},mn=/^[a-z]/,yn={type:"class",value:"[a-z]",description:"[a-z]"},xn="tau",Cn={type:"literal",value:"tau",description:'"tau"'},wn="\u03c4",An={type:"literal",value:"\u03c4",description:'"\\u03C4"'},bn="|",Pn={type:"literal",value:"|",description:'"|"'},_n="\u2016",zn={type:"literal",value:"\u2016",description:'"\\u2016"'},kn="+",$n={type:"literal",value:"+",description:'"+"'},Sn="new",jn={type:"literal",value:"new",description:'"new"'},En="\u03bd",In={type:"literal",value:"\u03bd",description:'"\\u03BD"'},Nn=function(){return D([])},Rn="zero",Fn={type:"literal",value:"zero",description:'"zero"'},On="0",Tn={type:"literal",value:"0",description:'"0"'},Ln={type:"other",description:"spaces"},Gn=/^[ \n\t]/,qn={type:"class",value:"[ \\n\\t]",description:"[ \\n\\t]"},Wn={type:"other",description:"space"},Zn={type:"other",description:"comment"},Un="/*",Hn={type:"literal",value:"/*",description:'"/*"'},Mn="*/",Bn={type:"literal",value:"*/",description:'"*/"'},Dn={type:"any",description:"any character"},Jn="//",Kn={type:"literal",value:"//",description:'"//"'},Yn=/^[^\n]/,Qn={type:"class",value:"[^\\n]",description:"[^\\n]"},Vn="\n",Xn={type:"literal",value:"\n",description:'"\\n"'},te=0,ne=0,ee=[{line:1,column:1,seenCR:!1}],re=0,oe=[],ie=0,ae;if("startRule"in V){if(!(V.startRule in nt))throw new Error("Can't start parsing from rule \""+V.startRule+'".');et=nt[V.startRule]}if(ae=et(),ae!==tt&&te===t.length)return ae;throw ae!==tt&&te<t.length&&c({type:"end",description:"end of input"}),u(null,oe,re<t.length?t.charAt(re):null,re<t.length?s(re,re+1):s(re,re))}return t(n,Error),{SyntaxError:n,parse:e}}(),function(){function lookup(t){for(var n=arguments.length-1;!(1>n||t in arguments[n]);)n--;if(1>n)throw Error("Unknown name "+t);return arguments[n][t]}function compile(txt){var ast=txt;"string"==typeof ast&&(ast=parsePi.parse(txt));var prog={defs:{},init:[],sourceCode:txt},defs=ast.defs,cdefs=[];for(var pvar in defs){var comp=defs[pvar].body.components,ccomp=[],fargs={};for(var n in defs[pvar].args)fargs[defs[pvar].args[n]]="x"+n;for(var c in comp)if("input"===comp[c].action.type){var aargs={};for(var n in comp[c].action.args)aargs[comp[c].action.args[n]]="y"+n;var cinp="Receive("+fargs[comp[c].action.channel]+", ";cinp+="function("+comp[c].action.args.map(function(t,n){return"y"+n}).join(",")+") {\n";var procs,cargs={};if("New"===comp[c].cont.type){var ns=comp[c].cont.names;for(var n in ns)cargs[ns[n].name]="z"+n,cinp+="var z"+n+' = new Channel("'+ns[n].name+'");\n';procs=comp[c].cont.proc.components}else{if("Parall"!==comp[c].cont.type)throw Error("Expecting a normalised process! line: "+comp[c].action.loc.start.line);

procs=comp[c].cont.components}var cconts=[];for(var pc in procs){if("PiCall"!==procs[pc].type)throw Error("Unexpected "+procs[pc].type+" at line "+procs[pc].loc.start.line);var callargs=procs[pc].args;for(var a in callargs)callargs[a]=lookup(callargs[a],fargs,aargs,cargs);cconts.push("ProcCall('"+procs[pc].pvar+"', ["+callargs.join(",")+"]"+(procs[pc].heir?", true":"")+")")}cinp+="return [\n"+cconts.join(",")+"\n];})",ccomp.push(cinp)}else if("output"===comp[c].action.type){var cout="Send("+fargs[comp[c].action.channel]+", [",aargs=[];for(var n in comp[c].action.args)aargs.push(lookup(comp[c].action.args[n],fargs));if(cout+=aargs.join(",")+"]",comp[c].cont&&("Parall"!==comp[c].cont.type||comp[c].cont.components.length>0)){cout+=", function() {\n";var procs,cargs={};if("New"===comp[c].cont.type){var ns=comp[c].cont.names;for(var n in ns)cargs[ns[n].name]="z"+n,cout+="var z"+n+' = new Channel("'+ns[n].name+'");\n';procs=comp[c].cont.proc.components}else{if("Parall"!==comp[c].cont.type)throw Error("Expecting a normalised process! line: "+comp[c].action.loc.start.line);procs=comp[c].cont.components}var cconts=[];for(var pc in procs){if("PiCall"!==procs[pc].type)throw Error("Unexpected "+procs[pc].type+" at line "+procs[pc].loc.start.line);var callargs=procs[pc].args;for(var a in callargs)callargs[a]=lookup(callargs[a],fargs,cargs);cconts.push("ProcCall('"+procs[pc].pvar+"', ["+callargs.join(",")+"]"+(procs[pc].heir?", true":"")+")")}cout+="return [\n"+cconts.join(",")+"\n];}"}cout+=")",ccomp.push(cout)}else if("tau"===comp[c].action.type){var cout="Tau(";if(comp[c].cont&&("Parall"!==comp[c].cont.type||comp[c].cont.components.length>0)){cout+="function() {\n";var procs,cargs={};if("New"===comp[c].cont.type){var ns=comp[c].cont.names;for(var n in ns)cargs[ns[n].name]="z"+n,cout+="var z"+n+' = new Channel("'+ns[n].name+'");\n';procs=comp[c].cont.proc.components}else{if("Parall"!==comp[c].cont.type)throw Error("Expecting a normalised process! line: "+comp[c].action.loc.start.line);procs=comp[c].cont.components}var cconts=[];for(var pc in procs){if("PiCall"!==procs[pc].type)throw Error("Unexpected "+procs[pc].type+" at line "+procs[pc].loc.start.line);var callargs=procs[pc].args;for(var a in callargs)callargs[a]=lookup(callargs[a],fargs,cargs);cconts.push("ProcCall('"+procs[pc].pvar+"', ["+callargs.join(",")+"]"+(procs[pc].heir?", true":"")+")")}cout+="return [\n"+cconts.join(",")+"\n];}"}cout+=")",ccomp.push(cout)}var alt="function(";alt+=defs[pvar].args.map(function(t,n){return"x"+n}).join(","),alt+="){return Alt([\n",alt+=ccomp.join(",\n"),alt+="\n]);}",cdefs.push("'"+pvar+"': "+alt)}prog.init=collect_procs(ast.start);var str_defs="PiDefs({"+cdefs.join(",\n")+"})";return prog.defs=eval(str_defs),prog}function collect_procs(t,n,e){if(n=n||{},e=e||{},"New"===t.type){var r=$.extend({},e);for(var o in t.names)r[t.names[o].name]=new Channel(t.names[o].name);return collect_procs(t.proc,n,r)}if("Parall"===t.type){var i=[];for(var a in t.components){var s=collect_procs(t.components[a],n,e);i=i.concat(s)}return i}if("PiCall"===t.type){var c=t.args;for(var u in c)try{c[u]=lookup(c[u],n,e)}catch(l){n[c[u]]=new Channel(c[u],!0),c[u]=n[c[u]]}return[ProcCall(t.pvar,c)]}if("Alt"===t.type)throw Error("Sums not supported at top level. Wrap them in definitions.")}function stxerr(t,n){var e=new Error(t);return e.location=n,e}function validate_syntax(t){for(var n in t.defs){var e=t.defs[n].body;if("Alt"!==e.type)throw stxerr("Normalise your definitions! Your definition for "+n+" does not have a sum at the top level.",e.loc);for(var r in e.components)check_free_names(e.components[r],t.defs[n].args)}}function check_free_names(t,n){if("New"===t.type)check_free_names(t.proc,n.concat(t.names.map(function(t){return t.name})));else if("PiCall"===t.type){for(var e in t.args)if(n.indexOf(t.args[e])<0)throw stxerr("Name '"+t.args[e]+"' out of scope.",t.loc)}else if("Parall"===t.type)for(var e in t.components)check_free_names(t.components[e],n);else{if("Alt"===t.type)throw stxerr("Normalize your code! Sums only allowed at the top-level of a definition!",t.loc);if(void 0!==t.action)if("tau"===t.action.type)check_free_names(t.cont,n);else{if(n.indexOf(t.action.channel)<0)throw stxerr("Name '"+t.action.channel+"' out of scope.",t.loc);if("input"===t.action.type)check_free_names(t.cont,n.concat(t.action.args));else if("output"===t.action.type){for(var e in t.args)if(n.indexOf(t.args[e])<0)throw stxerr("Name '"+t.args[e]+"' out of scope.",t.loc);check_free_names(t.cont,n)}}}}window.parsePi.compile=compile,window.parsePi.validate=validate_syntax,window.parsePi.compileAndCheck=function(t){return t=parsePi.parse(t),validate_syntax(t),compile(t)}}();var gistUrlPattern=/^(https?:\/\/)?gist\.github\.com.*\/([a-zA-Z0-9]*)$/,Stargazer=function(){function t(e,a,s){function c(){$(d.node()).height(function(){return $(this).parent().innerHeight()}).width(function(){return $(this).parent().innerWidth()}).attr("width",function(){return $(this).width()}).attr("height",function(){return $(this).height()}),l&&l.translate([d.attr("width")/2,d.attr("height")/2])}function u(){n(h.node())?k.freeze():k.unfreeze()}if(!(this instanceof t))return new t(e,a,s);s=$.extend({zoom:1,delay:500,gravity:!0,showLabels:!0,playOnLoad:!1,autoFreeze:!0,autoResize:!0},s);var l,p=+s.zoom,f=s.palette?{palette:s.palette}:void 0,h=d3.select(e);h.selectAll(o).remove(),h.append("svg").classed(r,!0);var d=h.select(o);h.datum(this),void 0===a&&(a="0");var v=a,g=parsePi.compileAndCheck(v);l=PiCalcSimulation(d,g,f),l.scale(p);for(var m=10;m>0;--m)l.layout().tick();this.simulator=function(){return l},this.program=function(t){return void 0===t?v:(g=parsePi.compileAndCheck(t),v=t,this.reset(),void 0)},this.resizeCanvas=c,s.autoResize&&($(h.node()).on("div-resize",c),c()),this.gravity=function(t){return void 0===t?l.layout().gravity()>.05:void(t?l.layout().gravity(.2).charge(-400).start():l.layout().gravity(1e-5).charge(-30).start())},this.gravity(s.gravity);var y=function(){return l.next(l.randomStrategy),this};this.step=y;var x=s.delay,C,w=!1,A=!1;this.running=function(){return w},this.delay=function(){return x};var b=$("<div class='controls'></div>").appendTo(h.node()),P=$("<div class='control play'></div>").click(function(){w?k.pause():k.play()}).appendTo(b),_=$("<div class='control open'></div>").click(function(){k.pause(),window.open(i+(s.link||"?program="+encodeURIComponent(v)))}).appendTo(b),z=$("<div class='control reset'></div>").click(function(){k.reset()}).appendTo(b);this.play=function(t){return!w||void 0!==t&&+t!==x?(void 0!==t&&(x=+t),clearInterval(C),A||(C=setInterval(y,x)),P.removeClass("play").addClass("pause"),w=!0,this):this},this.delay=function(t){return void 0===t?x:(w?this.play(t):x=+t,this)},this.pause=function(){return clearInterval(C),P.removeClass("pause").addClass("play"),w=!1,this},this.freeze=function(){return A=!0,clearInterval(C),this},this.unfreeze=function(){return w&&A&&(C=setInterval(y,x)),A=!1,this},this.reset=function(){return this.pause(),d.selectAll("*").remove(),l=PiCalcSimulation(d,g,f),l.scale(p),this},s.playOnLoad&&this.play();var k=this;this.autoFreeze=u,s.autoFreeze&&$(h.node()).on("view-change",u),this.showLabels=function(t){return 0===arguments.length?d.classed("labels"):(d.classed("labels",t),this)},this.toggleLabels=function(){return d.classed("labels",!d.classed("labels")),this},this.showGlobals=function(t){return 0===arguments.length?d.classed("globals"):(d.classed("globals",t),this)},this.toggleGlobals=function(){return d.classed("globals",!d.classed("globals")),this},s.showLabels&&this.showLabels(s.showLabels),s.showGlobals&&this.showLabels(s.showGlobals)}function n(t){var n=t.getBoundingClientRect(),e=$(window),r=e.height(),o=e.width();return n.right<0||n.bottom<0||n.top>r||n.left>o}var e=/^(.*)_(\d*)$/,r="stargazer-viz",o="svg."+r,i="http://stargazer.emanueledosualdo.com";return t}();$(function(){function t(t,n){var e;return function(){clearTimeout(e),e=setTimeout(t,n||250)}}var n=function(){function t(t,n){t.name=t.name||n["default"],t.sourceCode=n.programs[t.name].sourceCode,t.options=$.extend({},n.programs[t.name].options,t.options),t.options.link="?gist="+encodeURIComponent(t.sourceId)+"#"+t.name}function n(n,r){var o={name:void 0,sourceCode:"0",source:"none",sourceId:"",options:{}};o.options.gravity="false"!==n.attr("data-gravity");var i=n.attr("data-palette");if(i&&(o.options.palette={},i.split(";").map(function(t){var n=t.split(":");return[n[0].trim(),n[1].trim()]}).each(function(t){o.options.palette[t[0]]=t[1]})),o.options.showLabels="true"===n.attr("data-labels")||n.hasClass("labels"),o.options.showGlobals="true"===n.attr("data-globals")||n.hasClass("globals"),o.options.playOnLoad="true"===n.attr("data-play-on-load"),o.options.delay=n.attr("data-delay"),o.options.zoom=n.attr("data-zoom"),o.name=n.attr("data-program"),n.attr("data-gist")){if(o.source="gist",o.sourceId=n.attr("data-gist"),!(o.sourceId in e))return suiteFromGist(o.sourceId,function(i){return i&&i.successful?(e[o.sourceId]=i,t(o,i),r(o)):void n.addClass("error")});t(o,e[o.sourceId])}else n.find('script[type="text/x-stargazer"]').size()>0?(o.source="inline-script",o.sourceCode=n.find('script[type="text/x-stargazer"]').text()):$('script[type="text/x-stargazer"]#'+o.name).size()>0&&(o.source="script",o.sourceCode=$('script[type="text/x-stargazer"]#'+o.name).text());setTimeout(function(){return r(o)},0)}var e={};return n}();$("div.stargazer").each(function(t){var e=$(this),r=this;e.addClass("loading").removeClass("error"),n(e,function(t){e.removeClass("loading");try{Stargazer(r,t.sourceCode,t.options)}catch(n){e.addClass("program error")}})}),$(window).resize(t(function(){$("div.stargazer").trigger("div-resize")})),$(window).scroll(t(function(){$("div.stargazer").trigger("view-change")}))});