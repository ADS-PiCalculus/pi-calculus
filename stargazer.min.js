"use strict";function suiteFromGist(t,n){var e={source:"gist",successful:!0,programs:{}},r,o=function(){if(e.successful===!0){e.url=r.html_url;var t;try{t=JSON.parse(r.files["default.json"].content)}catch(o){t={}}t["default"]&&t["default"]+".pi"in r.files&&(e["default"]=t["default"]),delete t["default"];for(var i in r.files)if(i.endsWith(".pi")){var a=i.slice(0,-3);if(e.programs[a]={name:a,sourceCode:r.files[i].content,options:$.extend({},t)},a+".json"in r.files)try{$.extend(e.programs[a].options,JSON.parse(r.files[a+".json"].content))}catch(o){console.log("Warning",o)}}var s=Object.keys(e.programs);s.length<1?(e.successful=!1,e.error="empty",e.reason="This suite is empty. A program suite must contain at least one program."):e["default"]||(e["default"]=Object.keys(e.programs)[0])}return n(e)};if("string"!=typeof t)return t.files?(r=t,e.source="stored-gist",e.description=r.description,o()):(e.error="Wrong parameters",n(e));e.id=t;var i=t.match(gistUrlPattern);i?t="http://api.github.com/gists/"+i[2]:t.startsWith("http")||(t="http://api.github.com/gists/"+t),$.ajax(t,{cache:!0,success:function(t){if(r=t,t.truncated===!0)return e.error="truncated",e.reason="The gist is too big",o();e.description=t.description;var n=0,i=0;for(var a in t.files)i++,t.files[a].truncated?$.ajax(t.files[a].raw_url,{success:function(t){return function(n){t.content=n,t.truncated=!1}}(t.files[a]),complete:function(t,r){return n++,n===i?(e.successful=e.successful&&"success"===r,o()):void 0}}):n++;return n===i?o():void 0},error:function(t,n,r){return e.successful=!1,e.error=n,e.reason=r,o()}})}function suiteSize(t){return Object.keys(t.programs).length}function createGistFromSuite(t,n,e){var r={description:t.description,"public":!1,files:{}};for(var o in t.programs)r.files[o+".pi"]={content:t.programs[o].sourceCode},$.isEmptyObject(t.programs[o].options)||(r.files[o+".json"]={content:JSON.stringify(t.programs[o].options)});return $.ajax({url:"http://api.github.com/gists",type:"POST",data:JSON.stringify(r),success:n,error:e}),r}var Channel=function(){function t(e,r){return this instanceof t?(this.name=e,this.global=r===!0,n[e]||(n[e]=0),this.unique=n[e],void n[e]++):new t(e,r)}var n={};return t.prototype.toPiCalc=function(){return this.global===!0?this.name:this.name+"_"+this.unique},t.prototype.is=function(t){return this===t},t.prototype.toString=function(){return this.name+"#"+this.unique},t}(),ProcCall=function(){function t(e,r){return this instanceof t?(this.proc_name=e,this.args=r||[],void(this.unique=n++)):new t(e,r)}var n=0;return t.prototype.toPiCalc=function(){return this.proc_name+"["+this.args.map(function(t){return t.toPiCalc()}).join(",")+"]"},t}(),Action=function(){function t(){return this instanceof t?void 0:new t}return t}(),Tau=function(){function t(n){return this instanceof t?void(this.continuation=n):new t(n)}return t.prototype=new Action,t.prototype.constructor=t,t.prototype.fire=function(){return this.continuation instanceof Function?this.continuation():void 0},t.prototype.toPiCalc=function(){return"\u03c4..."},t}(),Receive=function(){function t(n,e){return this instanceof t?(this.channel=n,this.continuation=e||function(){},void(this.arity=e.length)):new t(n,e)}return t.prototype=new Action,t.prototype.constructor=t,t.prototype.fire=function(t){return this.continuation instanceof Function?this.continuation.apply(null,t):void 0},t.prototype.toPiCalc=function(){for(var t=[],n=0;n<this.arity;n++)t.push("_");return this.channel.toPiCalc()+"?("+t.join(",")+")..."},t}(),Send=function(){function t(n,e,r){return this instanceof t?(this.channel=n,this.args=e||[],this.arity=this.args.length,void(this.continuation=r)):new t(n,e,r)}return t.prototype=new Action,t.prototype.constructor=t,t.prototype.fire=function(){return this.continuation instanceof Function?this.continuation():void 0},t.prototype.toPiCalc=function(){return this.channel.toPiCalc()+"!("+this.args.map(function(t){return t.toPiCalc()}).join(",")+")..."},t}(),Alt=function(){function t(n){return this instanceof t?void(this.alts=n||[]):new t(n)}return t.prototype.enabled_on=function(t,n){return this.waiting_on(t).length>0},t.prototype.waiting_on=function(t,n){return this.receiving_on(t).concat(this.sending_on(t))},t.prototype.receiving_on=function(t,n){return this.alts.filter(function(e){if(e instanceof Receive){var r=void 0==n||e.arity==n;return e.channel.is(t)&&r}return!1})},t.prototype.sending_on=function(t,n){return this.alts.filter(function(e){if(e instanceof Send){var r=void 0==n||e.arity==n;return e.channel.is(t)&&r}return!1})},t.prototype.taus=function(){return this.alts.filter(function(t){return t instanceof Tau})},t.prototype.toPiCalc=function(){return"("+this.alts.map(function(t){return t.toPiCalc()}).join(" + ")+")"},t}(),Zero=void 0,PiDefs=function(){function t(n){return this instanceof t?void(this.defs=n):new t(n)}return t.prototype.unfold=function(t){if(t.proc_name in this.defs){var n=this.defs[t.proc_name];return n.length!==t.args.length?Zero:n.apply(n,t.args)}return Zero},t}(),Config=function(){function t(n,e){return this instanceof t?(this.defs=n,this.names_index={},this.init=e,this.nodes=[],this.procsIndex=0,this.epoch=0,this.links=[],this.mergeCalls(e,{x:0,y:0}),void this.recomputeLinks()):new t(n,e)}function n(t){var n=60;return t+Math.random()*n-n/2}function e(t,n){return void 0!=t&&"x"in t&&"y"in t?void 0!=n&&"x"in n&&"y"in n?{x:(t.x+n.x)/2,y:(t.y+n.y)/2}:{x:t.x,y:t.y}:void 0}function r(t){for(var n=t.length,e,r;n;)r=Math.floor(Math.random()*n--),e=t[n],t[n]=t[r],t[r]=e;return t}t.prototype.mergeCalls=function(t,e){var r=[],o=[],i=this;return void 0==t?{names:[],procs:[]}:(e=e||{x:0,y:0},t.forEach(function(t){if(t){t.args.forEach(function(t){t in i.names_index||(i.names_index[t]={refCount:0,age:0},void 0!=e&&(t.x=n(e.x),t.y=n(e.y)),r.push(t)),i.names_index[t].refCount++});var a={call:t,body:i.defs.unfold(t),age:i.epoch};void 0!=e&&(a.x=n(e.x),a.y=n(e.y)),o.push(a)}}),this.nodes.unshift.apply(this.nodes,r),this.nodes.push.apply(this.nodes,o),this.procsIndex+=r.length,{names:r,procs:o})},t.prototype.addCalls=function(t){"string"==typeof t&&(t=t.split("|"));for(var n,e=[],r=0;r<t.length;r++)try{for(var o=t[r].trim().split("["),i=o[0],a=o[1].split("]")[0].split(",").map(function(t){return t.trim()}),s=this.getNames(),c=0;c<a.length;c++){var u=s.find(function(t){return t.toPiCalc()==a[c]});u?a[c]=u:(u=e.find(function(t){return t.name==a[c]}),u?a[c]=u:(a[c]=Channel(a[c]),e.push(a[c])))}t[r]=ProcCall(i,a)}catch(l){return console.log(l),!1}return this.mergeCalls(t,n),this.recomputeLinks(),!0},t.prototype.gcNames=function(){for(var t in this.names_index)this.names_index[t].refCount<=0&&delete this.names_index[t];for(var n=0;n<this.procsIndex;)this.nodes[n]in this.names_index?n++:(this.nodes.splice(n,1),this.procsIndex--)},t.prototype.redexes=function(){for(var t=this.procsIndex,n=[];t<this.nodes.length;){if(this.nodes[t].body){var e=this.nodes[t];n=n.concat(e.body.taus().map(function(n){return{type:"tau",index:t,action:n,process:e}}))}t++}for(var r=[],o=0;o<this.procsIndex;){for(var i=[],a=[],t=this.procsIndex;t<this.nodes.length;){if(this.nodes[t].body){var e=this.nodes[t],s=e.body.receiving_on(this.nodes[o]),c=e.body.sending_on(this.nodes[o]);s.forEach(function(n){a.push({index:t,action:n,process:e})}),c.forEach(function(n){i.push({index:t,action:n,process:e})})}t++}for(var u=0,l=!1;u<i.length;){for(var p=0;p<a.length;){var f=i[u],h=a[p];f.index!=h.index&&f.action.arity==h.action.arity&&(r.push({type:"comm",sender:f,receiver:h}),l=!0),p++}u++}l?this.names_index[this.nodes[o]].age++:this.names_index[this.nodes[o]].age=0,o++}return n.concat(r)};var o=function(t){return{pick:function(n){r(n);for(var e=t.epoch+1,o,i=n.length-1;i>=0;i--){var a;a="tau"==n[i].type?t.nodes[n[i].index].age:Math.min(t.nodes[n[i].sender.index].age,t.nodes[n[i].receiver.index].age),e>=a&&(e=a,o=i)}return void 0!=o?n[o]:void 0}}};return t.prototype.next=function(t){void 0==t&&(t=o(this));var n=this.redexes();if(n.length<=0)return!1;var e=t.pick(n);return void 0==e?!1:(this.makeReact(e),!0)},t.prototype.makeReact=function(t){if("tau"==t.type){var n=e(this.nodes[t.index]),r=t.action.fire();this.removeProc(t.index),this.mergeCalls(r,n)}else{var n=e(this.nodes[t.sender.index],this.nodes[t.receiver.index]),o=t.sender.action.fire(),i=t.receiver.action.fire(t.sender.action.args),a=t.sender.index,s=t.receiver.index;this.removeProc(a>s?a:s),this.removeProc(a>s?s:a),this.mergeCalls(o,n),this.mergeCalls(i,n)}return this.gcNames(),this.recomputeLinks(),this.epoch++,this},t.prototype.removeProc=function(t){if(t>=this.nodes.length||t<this.procsIndex)return!1;var n=this.names_index;return this.nodes[t].call.args.forEach(function(t){n[t].refCount--}),this.nodes.splice(t,1),!0},t.prototype.getNames=function(){return this.nodes.slice(0,this.procsIndex)},t.prototype.getProcs=function(){return this.nodes.slice(this.procsIndex)},t.prototype.recomputeLinks=function(){var t=this.links;t.splice(0,this.links.length);for(var n=this.procsIndex;n<this.nodes.length;n++){var e=this.nodes[n];e.call.args.forEach(function(n){t.push({source:e,target:n})})}},t.prototype.toPiCalc=function(){var t="",n=this.getNames().filter(function(t){return t.global!==!0}),e=this.getProcs();return n.length>0&&(t+="\u03bd"+n.map(function(t){return t.toPiCalc()}).join(",")+"."),e.length>0?(e.length>1&&(t+="( "),t+=e.map(function(t){return t.call.toPiCalc()}).join(" | "),e.length>1&&(t+=" )")):t+="0",t},t}(),PiCalcSimulation=function(){function t(o,i,a){function s(t){return d[t]||(v++,d[t]=n(v)),d[t]}function c(t){d3.event.altKey&&d3.select(this).classed("fixed",t.fixed=!t.fixed)}function u(t){d3.select(this).classed("fixed",t.fixed=!0)}if(!(this instanceof t))return new t(o,i,a);var l=i.defs,p=i.init,f=Config(l,p);this.q=f,a=a||{};for(var h in e)e.hasOwnProperty(h)&&!a.hasOwnProperty(h)&&(a[h]=e[h]);this.options=a;var d={Ghost:"white"},v=0;for(var g in a.palette)d[g]=a.palette[g];for(var g in l.defs)s(g);var m=d3.layout.force().charge(-400).linkDistance(function(t){return t.target.global?100:30}).linkStrength(function(t){return t.target.global?.01:.9}).friction(.8).nodes(f.nodes).links(f.links);this.layout=function(){return m};var y=o;o=o.append("g"),o.append("g").attr("id","links"),o.append("g").attr("id","nodes"),o.append("g").attr("id","labels");var x=o.select("#links").selectAll(".link"),C=o.select("#nodes").selectAll(".node .name"),w=o.select("#nodes").selectAll(".node .seq"),b=o.select("#labels").selectAll(".lbl"),A=o.select("#labels").selectAll(".name-lbl"),P=d3.behavior.zoom().scaleExtent([-10,10]).translate([y.attr("width")/2,y.attr("height")/2]).on("zoom",function(){o.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")});y.call(P),this.translate=function(){return arguments.length>0?P.translate.apply(P,arguments).event(o):P.translate()},this.scale=function(){return arguments.length>0?P.scale.apply(P,arguments).event(o):P.scale()},this.zoom=function(){return P},this.legend=function(){var t=[];for(var n in d)"Ghost"!==n&&t.push({name:n,color:d[n]});return t};var _=m.drag().on("dragstart",function(){d3.event.sourceEvent.stopPropagation()});this.update=function(){x=x.data(f.links),C=C.data(f.getNames(),function(t){return t.toString()}),w=w.data(f.getProcs(),function(t){return t.call.unique}),b=b.data(f.getProcs(),function(t){return t.call.unique}),A=A.data(f.getNames(),function(t){return t.toString()}),x.exit().remove(),x.enter().append("line").classed("link",!0),x.classed("global",function(t){return t.target.global}),b.exit().remove(),b.enter().append("text").attr("class","lbl").text(function(t){return t.color=s(t.call.proc_name),"Ghost"===t.call.proc_name?"":t.call.proc_name}),A.exit().remove(),A.enter().append("text").attr("class","nlbl").classed("global",function(t){return t.global}).html(function(t){return t.toPiCalc().replace(r,'$1 <tspan dy=".3em" dx="-.9em" style="font-size:60%">$2</tspan>')}),C.exit().remove(),C.classed("fixed",function(t){return t.fixed}),C.enter().append("circle").classed({node:!0,name:!0}).classed("global",function(t){return t.global}).attr("r",a.nameSize).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).on("click",c).call(_).append("title").text(function(t){return t.toPiCalc()});var t=a.procWidth/2,n=a.procHeight/2;return w.exit().remove(),w.enter().append("rect").attr("class","node seq").attr("width",a.procWidth).attr("height",a.procHeight).attr("x",function(n){return n.x-t}).attr("y",function(t){return t.y-n}).style("fill",function(t){return t.color}).on("click",function(t){console.info(t.call.toPiCalc(),t.x,t.y)}).on("click",c).call(_).append("title").text(function(t){return t.call.toPiCalc()}),m.start(),this};var z=void 0;this.init=function(t){return z=t,this};var k=function(t){return t.x},$=function(t){return t.y};m.on("tick",function(){var t=a.procWidth/2,n=a.procHeight/2,e=k,r=$;if(void 0!=a.collapse){var o;e=function(t){return t instanceof Channel&&t.name==a.collapse?(void 0==o&&(o=t),o.x):t.x},r=function(t){return t instanceof Channel&&t.name==a.collapse?(void 0==o&&(o=t),o.y):t.y}}x.attr("x1",function(t){return e(t.source)}).attr("y1",function(t){return r(t.source)}).attr("x2",function(t){return e(t.target)}).attr("y2",function(t){return r(t.target)}),C.attr("cx",e).attr("cy",r),b.attr("x",function(t){return e(t)}).attr("y",function(t){return r(t)-a.procHeight}),A.attr("x",function(t){return e(t)}).attr("y",function(t){return r(t)-a.nameSize-5}),w.attr("x",function(n){return n.x-t}).attr("y",function(t){return t.y-n}),z&&(z(),z=void 0)}),this.update(),P.event(o)}var n=d3.scale.category20(),e={nameSize:5,procWidth:18,procHeight:12},r=/^(.*)_(\d*)$/;return t.prototype.randomStrategy={pick:function(t){return t[Math.floor(Math.random()*t.length)]}},t.prototype.next=function(t){return this.q.next(t)?(this.update(),!0):!1},t}();window.parsePi=function(){function t(t,n){function e(){this.constructor=t}e.prototype=n.prototype,t.prototype=new e}function n(t,e,r,o){this.message=t,this.expected=e,this.found=r,this.location=o,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,n)}function e(t){function e(){return t.substring(Xn,Vn)}function r(){return s(Xn,Vn)}function o(n){throw u(null,[{type:"other",description:n}],t.substring(Xn,Vn),s(Xn,Vn))}function i(n){throw u(n,null,t.substring(Xn,Vn),s(Xn,Vn))}function a(n){var e=te[n],r,o;if(e)return e;for(r=n-1;!te[r];)r--;for(e=te[r],e={line:e.line,column:e.column,seenCR:e.seenCR};n>r;)o=t.charAt(r),"\n"===o?(e.seenCR||e.line++,e.column=1,e.seenCR=!1):"\r"===o||"\u2028"===o||"\u2029"===o?(e.line++,e.column=1,e.seenCR=!0):(e.column++,e.seenCR=!1),r++;return te[n]=e,e}function s(t,n){var e=a(t),r=a(n);return{start:{offset:t,line:e.line,column:e.column},end:{offset:n,line:r.line,column:r.column}}}function c(t){ne>Vn||(Vn>ne&&(ne=Vn,ee=[]),ee.push(t))}function u(t,e,r,o){function i(t){var n=1;for(t.sort(function(t,n){return t.description<n.description?-1:t.description>n.description?1:0});n<t.length;)t[n-1]===t[n]?t.splice(n,1):n++}function a(t,n){function e(t){function n(t){return t.charCodeAt(0).toString(16).toUpperCase()}return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(t){return"\\x0"+n(t)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(t){return"\\x"+n(t)}).replace(/[\u0100-\u0FFF]/g,function(t){return"\\u0"+n(t)}).replace(/[\u1000-\uFFFF]/g,function(t){return"\\u"+n(t)})}var r=new Array(t.length),o,i,a;for(a=0;a<t.length;a++)r[a]=t[a].description;return o=t.length>1?r.slice(0,-1).join(", ")+" or "+r[t.length-1]:r[0],i=n?'"'+e(n)+'"':"end of input","Expected "+o+" but "+i+" found."}return null!==e&&i(e),new n(null!==t?t:a(e,r),e,r,o)}function l(){var t,n,e,r,o;return t=Vn,n=W(),n!==tt?(e=h(),e!==tt?(r=W(),r!==tt?(o=p(),o!==tt?(Xn=t,n=rt(e,o),t=n):(Vn=t,t=tt)):(Vn=t,t=tt)):(Vn=t,t=tt)):(Vn=t,t=tt),t}function p(){var t,n,e,r,o;for(t=Vn,n=[],e=Vn,r=f(),r!==tt?(o=W(),o!==tt?(Xn=e,r=ot(r),e=r):(Vn=e,e=tt)):(Vn=e,e=tt);e!==tt;)n.push(e),e=Vn,r=f(),r!==tt?(o=W(),o!==tt?(Xn=e,r=ot(r),e=r):(Vn=e,e=tt)):(Vn=e,e=tt);return n!==tt&&(Xn=t,n=it(n)),t=n}function f(){var n,e,r,o,i,a;return re++,n=Vn,e=z(),e!==tt?(r=W(),r!==tt?(t.substr(Vn,2)===st?(o=st,Vn+=2):(o=tt,0===re&&c(ct)),o!==tt?(i=W(),i!==tt?(a=h(),a!==tt?(Xn=n,e=ut(e,a),n=e):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt),re--,n===tt&&(e=tt,0===re&&c(at)),n}function h(){var t,n,e,r,o,i,a,s;if(re++,t=Vn,n=d(),n!==tt){for(e=[],r=Vn,o=W(),o!==tt?(i=O(),i!==tt?(a=W(),a!==tt?(s=d(),s!==tt?(Xn=r,o=pt(n,s),r=o):(Vn=r,r=tt)):(Vn=r,r=tt)):(Vn=r,r=tt)):(Vn=r,r=tt);r!==tt;)e.push(r),r=Vn,o=W(),o!==tt?(i=O(),i!==tt?(a=W(),a!==tt?(s=d(),s!==tt?(Xn=r,o=pt(n,s),r=o):(Vn=r,r=tt)):(Vn=r,r=tt)):(Vn=r,r=tt)):(Vn=r,r=tt);e!==tt?(Xn=t,n=ft(n,e),t=n):(Vn=t,t=tt)}else Vn=t,t=tt;return re--,t===tt&&(n=tt,0===re&&c(lt)),t}function d(){var n,e,r,o,i,a;return re++,n=G(),n===tt&&(n=v(),n===tt&&(n=Vn,e=k(),e!==tt&&(Xn=n,e=ht(e)),n=e,n===tt&&(n=Vn,e=w(),e!==tt&&(Xn=n,e=ht(e)),n=e,n===tt&&(n=Vn,40===t.charCodeAt(Vn)?(e=dt,Vn++):(e=tt,0===re&&c(vt)),e!==tt?(r=W(),r!==tt?(o=h(),o!==tt?(i=W(),i!==tt?(41===t.charCodeAt(Vn)?(a=gt,Vn++):(a=tt,0===re&&c(mt)),a!==tt?(Xn=n,e=yt(o),n=e):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt),n===tt&&(n=Vn,e=g(),e!==tt&&(Xn=n,e=xt(e)),n=e))))),re--,n===tt&&(e=tt,0===re&&c(lt)),n}function v(){var t,n;return re++,t=Vn,n=z(),n!==tt&&(Xn=t,n=wt(n)),t=n,re--,t===tt&&(n=tt,0===re&&c(Ct)),t}function g(){var t,n,e,r,o,i,a,s;if(t=Vn,n=m(),n!==tt){for(e=[],r=Vn,o=W(),o!==tt?(i=T(),i!==tt?(a=W(),a!==tt?(s=m(),s!==tt?(Xn=r,o=bt(n,s),r=o):(Vn=r,r=tt)):(Vn=r,r=tt)):(Vn=r,r=tt)):(Vn=r,r=tt);r!==tt;)e.push(r),r=Vn,o=W(),o!==tt?(i=T(),i!==tt?(a=W(),a!==tt?(s=m(),s!==tt?(Xn=r,o=bt(n,s),r=o):(Vn=r,r=tt)):(Vn=r,r=tt)):(Vn=r,r=tt)):(Vn=r,r=tt);e!==tt?(Xn=t,n=At(n,e),t=n):(Vn=t,t=tt)}else Vn=t,t=tt;return t}function m(){var n,e,r,o,i,a,s;return re++,n=Vn,e=b(),e!==tt?(r=W(),r!==tt?(o=Vn,46===t.charCodeAt(Vn)?(i=_t,Vn++):(i=tt,0===re&&c(zt)),i!==tt?(a=W(),a!==tt?(s=x(),s!==tt?(Xn=o,i=kt(e,s),o=i):(Vn=o,o=tt)):(Vn=o,o=tt)):(Vn=o,o=tt),o===tt&&(o=null),o!==tt?(Xn=n,e=$t(e,o),n=e):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt),re--,n===tt&&(e=tt,0===re&&c(Pt)),n}function y(){var t,n;return t=Vn,n=m(),n!==tt&&(Xn=t,n=St(n)),t=n}function x(){var t,n;return re++,t=G(),t===tt&&(t=k(),t===tt&&(t=C())),re--,t===tt&&(n=tt,0===re&&c(jt)),t}function C(){var n,e,r,o,i,a;return n=v(),n===tt&&(n=Vn,40===t.charCodeAt(Vn)?(e=dt,Vn++):(e=tt,0===re&&c(vt)),e!==tt?(r=W(),r!==tt?(o=h(),o!==tt?(i=W(),i!==tt?(41===t.charCodeAt(Vn)?(a=gt,Vn++):(a=tt,0===re&&c(mt)),a!==tt?(Xn=n,e=yt(o),n=e):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt),n===tt&&(n=Vn,e=y(),e!==tt&&(Xn=n,e=Et(e)),n=e)),n}function w(){var n,e,r,o;return re++,n=Vn,42===t.charCodeAt(Vn)?(e=Nt,Vn++):(e=tt,0===re&&c(Rt)),e!==tt?(r=W(),r!==tt?(o=C(),o!==tt?(Xn=n,e=Ft(o),n=e):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt),re--,n===tt&&(e=tt,0===re&&c(It)),n}function b(){var t,n;return re++,t=P(),t===tt&&(t=A(),t===tt&&(t=_())),re--,t===tt&&(n=tt,0===re&&c(Ot)),t}function A(){var n,e,r,o,i,a,s,u;return re++,n=Vn,e=R(),e!==tt?(r=W(),r!==tt?(40===t.charCodeAt(Vn)?(o=dt,Vn++):(o=tt,0===re&&c(vt)),o!==tt?(i=W(),i!==tt?(a=j(),a===tt&&(a=null),a!==tt?(s=W(),s!==tt?(41===t.charCodeAt(Vn)?(u=gt,Vn++):(u=tt,0===re&&c(mt)),u!==tt?(Xn=n,e=Lt(e,a),n=e):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt),re--,n===tt&&(e=tt,0===re&&c(Tt)),n}function P(){var n,e,r,o,i,a,s,u;return re++,n=Vn,e=R(),e!==tt?(r=W(),r!==tt?(60===t.charCodeAt(Vn)?(o=qt,Vn++):(o=tt,0===re&&c(Wt)),o!==tt?(i=W(),i!==tt?(a=j(),a===tt&&(a=null),a!==tt?(s=W(),s!==tt?(62===t.charCodeAt(Vn)?(u=Zt,Vn++):(u=tt,0===re&&c(Ut)),u!==tt?(Xn=n,e=Mt(e,a),n=e):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt),re--,n===tt&&(e=tt,0===re&&c(Gt)),n}function _(){var t,n;return t=Vn,n=F(),n!==tt&&(Xn=t,n=Ht()),t=n}function z(){var t,n,e,r;return t=Vn,n=N(),n!==tt?(e=W(),e!==tt?(r=S(),r===tt&&(r=null),r!==tt?(Xn=t,n=Bt(n,r),t=n):(Vn=t,t=tt)):(Vn=t,t=tt)):(Vn=t,t=tt),t}function k(){var n,e,r,o,i,a,s,u;return re++,n=Vn,e=L(),e!==tt?(r=W(),r!==tt?(o=$(),o!==tt?(i=W(),i!==tt?(46===t.charCodeAt(Vn)?(a=_t,Vn++):(a=tt,0===re&&c(zt)),a!==tt?(s=W(),s!==tt?(u=x(),u===tt&&(u=k()),u!==tt?(Xn=n,e=Jt(o,u),n=e):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt),re--,n===tt&&(e=tt,0===re&&c(Dt)),n}function $(){var n,e,r,o,i,a;return n=Vn,40===t.charCodeAt(Vn)?(e=dt,Vn++):(e=tt,0===re&&c(vt)),e!==tt?(r=W(),r!==tt?(o=E(),o!==tt?(i=W(),i!==tt?(41===t.charCodeAt(Vn)?(a=gt,Vn++):(a=tt,0===re&&c(mt)),a!==tt?(Xn=n,e=Kt(o),n=e):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt),n===tt&&(n=E()),n}function S(){var n,e,r,o,i,a;return re++,n=Vn,91===t.charCodeAt(Vn)?(e=Qt,Vn++):(e=tt,0===re&&c(Vt)),e!==tt?(r=W(),r!==tt?(o=j(),o===tt&&(o=null),o!==tt?(i=W(),i!==tt?(93===t.charCodeAt(Vn)?(a=Xt,Vn++):(a=tt,0===re&&c(tn)),a!==tt?(Xn=n,e=nn(o),n=e):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt)):(Vn=n,n=tt),re--,n===tt&&(e=tt,0===re&&c(Yt)),n}function j(){var n,e,r,o,i,a,s,u;if(re++,n=Vn,e=R(),e!==tt)if(r=W(),r!==tt){for(o=[],i=Vn,44===t.charCodeAt(Vn)?(a=rn,Vn++):(a=tt,0===re&&c(on)),a!==tt?(s=W(),s!==tt?(u=R(),u!==tt?(Xn=i,a=an(e,u),i=a):(Vn=i,i=tt)):(Vn=i,i=tt)):(Vn=i,i=tt);i!==tt;)o.push(i),i=Vn,44===t.charCodeAt(Vn)?(a=rn,Vn++):(a=tt,0===re&&c(on)),a!==tt?(s=W(),s!==tt?(u=R(),u!==tt?(Xn=i,a=an(e,u),i=a):(Vn=i,i=tt)):(Vn=i,i=tt)):(Vn=i,i=tt);o!==tt?(Xn=n,e=sn(e,o),n=e):(Vn=n,n=tt)}else Vn=n,n=tt;else Vn=n,n=tt;return re--,n===tt&&(e=tt,0===re&&c(en)),n}function E(){var n,e,r,o,i,a,s,u;if(re++,n=Vn,e=I(),e!==tt)if(r=W(),r!==tt){for(o=[],i=Vn,44===t.charCodeAt(Vn)?(a=rn,Vn++):(a=tt,0===re&&c(on)),a!==tt?(s=W(),s!==tt?(u=I(),u!==tt?(Xn=i,a=an(e,u),i=a):(Vn=i,i=tt)):(Vn=i,i=tt)):(Vn=i,i=tt);i!==tt;)o.push(i),i=Vn,44===t.charCodeAt(Vn)?(a=rn,Vn++):(a=tt,0===re&&c(on)),a!==tt?(s=W(),s!==tt?(u=I(),u!==tt?(Xn=i,a=an(e,u),i=a):(Vn=i,i=tt)):(Vn=i,i=tt)):(Vn=i,i=tt);o!==tt?(Xn=n,e=sn(e,o),n=e):(Vn=n,n=tt)}else Vn=n,n=tt;else Vn=n,n=tt;return re--,n===tt&&(e=tt,0===re&&c(en)),n}function I(){var t,n;return t=Vn,n=R(),n!==tt&&(Xn=t,n=cn(n)),t=n}function N(){var n,e,r,o,i;if(re++,n=Vn,e=Vn,ln.test(t.charAt(Vn))?(r=t.charAt(Vn),Vn++):(r=tt,0===re&&c(pn)),r!==tt){for(o=[],fn.test(t.charAt(Vn))?(i=t.charAt(Vn),Vn++):(i=tt,0===re&&c(hn));i!==tt;)o.push(i),fn.test(t.charAt(Vn))?(i=t.charAt(Vn),Vn++):(i=tt,0===re&&c(hn));o!==tt?(r=[r,o],e=r):(Vn=e,e=tt)}else Vn=e,e=tt;return n=e!==tt?t.substring(n,Vn):e,re--,n===tt&&(e=tt,0===re&&c(un)),n}function R(){var n,e,r,o,i;if(re++,n=Vn,e=Vn,vn.test(t.charAt(Vn))?(r=t.charAt(Vn),Vn++):(r=tt,0===re&&c(gn)),r!==tt){for(o=[],fn.test(t.charAt(Vn))?(i=t.charAt(Vn),Vn++):(i=tt,0===re&&c(hn));i!==tt;)o.push(i),fn.test(t.charAt(Vn))?(i=t.charAt(Vn),Vn++):(i=tt,0===re&&c(hn));o!==tt?(r=[r,o],e=r):(Vn=e,e=tt)}else Vn=e,e=tt;return n=e!==tt?t.substring(n,Vn):e,re--,n===tt&&(e=tt,0===re&&c(dn)),n}function F(){var n;return t.substr(Vn,3)===mn?(n=mn,Vn+=3):(n=tt,0===re&&c(yn)),n===tt&&(964===t.charCodeAt(Vn)?(n=xn,Vn++):(n=tt,0===re&&c(Cn))),n}function O(){var n;return 124===t.charCodeAt(Vn)?(n=wn,Vn++):(n=tt,0===re&&c(bn)),n===tt&&(8214===t.charCodeAt(Vn)?(n=An,Vn++):(n=tt,0===re&&c(Pn))),n}function T(){var n;return 43===t.charCodeAt(Vn)?(n=_n,Vn++):(n=tt,0===re&&c(zn)),n}function L(){var n;return t.substr(Vn,3)===kn?(n=kn,Vn+=3):(n=tt,0===re&&c($n)),n===tt&&(957===t.charCodeAt(Vn)?(n=Sn,Vn++):(n=tt,0===re&&c(jn))),n}function G(){var t,n;return t=Vn,n=q(),n!==tt&&(Xn=t,n=En()),t=n}function q(){var n;return t.substr(Vn,4)===In?(n=In,Vn+=4):(n=tt,0===re&&c(Nn)),n===tt&&(48===t.charCodeAt(Vn)?(n=Rn,Vn++):(n=tt,0===re&&c(Fn))),n}function W(){var t,n;for(t=[],n=U(),n===tt&&(n=M());n!==tt;)t.push(n),n=U(),n===tt&&(n=M());return t}function Z(){var n,e;for(re++,n=[],Tn.test(t.charAt(Vn))?(e=t.charAt(Vn),Vn++):(e=tt,0===re&&c(Ln));e!==tt;)n.push(e),Tn.test(t.charAt(Vn))?(e=t.charAt(Vn),Vn++):(e=tt,0===re&&c(Ln));return re--,n===tt&&(e=tt,0===re&&c(On)),n}function U(){var n,e;return re++,Tn.test(t.charAt(Vn))?(n=t.charAt(Vn),Vn++):(n=tt,0===re&&c(Ln)),re--,n===tt&&(e=tt,0===re&&c(Gn)),n}function M(){var n,e,r,o,i,a;if(re++,n=Vn,t.substr(Vn,2)===Wn?(e=Wn,Vn+=2):(e=tt,0===re&&c(Zn)),e!==tt){for(r=[],o=Vn,i=Vn,re++,t.substr(Vn,2)===Un?(a=Un,Vn+=2):(a=tt,0===re&&c(Mn)),re--,a===tt?i=void 0:(Vn=i,i=tt),i!==tt?(t.length>Vn?(a=t.charAt(Vn),Vn++):(a=tt,0===re&&c(Hn)),a!==tt?(i=[i,a],o=i):(Vn=o,o=tt)):(Vn=o,o=tt);o!==tt;)r.push(o),o=Vn,i=Vn,re++,t.substr(Vn,2)===Un?(a=Un,Vn+=2):(a=tt,0===re&&c(Mn)),re--,a===tt?i=void 0:(Vn=i,i=tt),i!==tt?(t.length>Vn?(a=t.charAt(Vn),Vn++):(a=tt,0===re&&c(Hn)),a!==tt?(i=[i,a],o=i):(Vn=o,o=tt)):(Vn=o,o=tt);r!==tt?(t.substr(Vn,2)===Un?(o=Un,Vn+=2):(o=tt,0===re&&c(Mn)),o!==tt?(e=[e,r,o],n=e):(Vn=n,n=tt)):(Vn=n,n=tt)}else Vn=n,n=tt;if(n===tt)if(n=Vn,t.substr(Vn,2)===Bn?(e=Bn,Vn+=2):(e=tt,0===re&&c(Dn)),e!==tt){for(r=[],Jn.test(t.charAt(Vn))?(o=t.charAt(Vn),Vn++):(o=tt,0===re&&c(Kn));o!==tt;)r.push(o),Jn.test(t.charAt(Vn))?(o=t.charAt(Vn),Vn++):(o=tt,0===re&&c(Kn));r!==tt?(10===t.charCodeAt(Vn)?(o=Yn,Vn++):(o=tt,0===re&&c(Qn)),o===tt&&(o=null),o!==tt?(e=[e,r,o],n=e):(Vn=n,n=tt)):(Vn=n,n=tt)}else Vn=n,n=tt;return re--,n===tt&&(e=tt,0===re&&c(qn)),n}function H(t){return null==t?[]:t}function B(t,n){return n.unshift(t),n}function D(t){return{type:"Parall",components:t}}function J(t){return{type:"Alt",components:t,loc:r()}}function K(t){return{type:"Bang",components:t,loc:r()}}function Y(t,n){return t.type!=n.type&&i("Merging uncompatible objects "+t.type+" and "+n.type),{type:t.type,components:t.components.concat(n.components)}}function Q(t,n){var e=t;for(var r in n)e=Y(e,n[r]);return e}var V=arguments.length>1?arguments[1]:{},X=this,tt={},nt={start:l},et=l,rt=function(t,n){return{start:t,defs:n}},ot=function(t){return t},it=function(t){for(var n={},e=0;e<t.length;e++){var r=t[e].pvar;r in n?i("Multiple definition for "+r):n[r]=t[e].def}return n},at={type:"other",description:"process definition"},st=":=",ct={type:"literal",value:":=",description:'":="'},ut=function(t,n){return("Parall"!==n.type||n.components.length>1)&&i("The top level of a definitions should be a sum"),0===n.components.length?n.type="Alt":(n=n.components[0],"Alt"!==n.type&&i("The top level of a definitions should be a sum")),{pvar:t.pvar,def:{args:t.args,body:n}}},lt={type:"other",description:"term"},pt=function(t,n){return n},ft=function(t,n){return Q(t,n)},ht=function(t){return D([t])},dt="(",vt={type:"literal",value:"(",description:'"("'},gt=")",mt={type:"literal",value:")",description:'")"'},yt=function(t){return t},xt=function(t){return D([t])},Ct={type:"other",description:"process call"},wt=function(t){return t.type="PiCall",D([t])},bt=function(t,n){return n},At=function(t,n){return J(B(t,n))},Pt={type:"other",description:"factor"},_t=".",zt={type:"literal",value:".",description:'"."'},kt=function(t,n){return n},$t=function(t,n){return null==n&&(n=D([])),{action:t,cont:n}},St=function(t){return J([t])},jt={type:"other",description:"continuation"},Et=function(t){return D([t])},It={type:"other",description:"replicated process"},Nt="*",Rt={type:"literal",value:"*",description:'"*"'},Ft=function(t){1!=t.components.length&&i("Only guarded replication is supported!");var n=t.components[0];return"Alt"!=n.type&&i("Only guarded replication is supported!"),K(n.components)},Ot={type:"other",description:"action prefix"},Tt={type:"other",description:"input action"},Lt=function(t,n){return{channel:t,type:"input",args:H(n),loc:r()}},Gt={type:"other",description:"output action"},qt="<",Wt={type:"literal",value:"<",description:'"<"'},Zt=">",Ut={type:"literal",value:">",description:'">"'},Mt=function(t,n){return{channel:t,type:"output",args:H(n),loc:r()}},Ht=function(){return{type:"tau",loc:r()}},Bt=function(t,n){return{pvar:t,args:H(n),loc:r()}},Dt={type:"other",description:"restriction"},Jt=function(t,n){return 0==t.length?n:"New"==n.type?{type:"New",names:t.concat(n.names),proc:n.proc}:{type:"New",names:t,proc:n}},Kt=function(t){return t},Yt={type:"other",description:"arguments list"},Qt="[",Vt={type:"literal",value:"[",description:'"["'},Xt="]",tn={type:"literal",value:"]",description:'"]"'},nn=function(t){return H(t)},en={type:"other",description:"list of names"},rn=",",on={type:"literal",value:",",description:'","'},an=function(t,n){return n},sn=function(t,n){return n.unshift(t),n},cn=function(t){return{name:t,loc:r()}},un={type:"other",description:"process identifier"},ln=/^[A-Z]/,pn={type:"class",value:"[A-Z]",description:"[A-Z]"},fn=/^[a-zA-Z0-9'_]/,hn={type:"class",value:"[a-zA-Z0-9'_]",description:"[a-zA-Z0-9'_]"},dn={type:"other",description:"name"},vn=/^[a-z]/,gn={type:"class",value:"[a-z]",description:"[a-z]"},mn="tau",yn={type:"literal",value:"tau",description:'"tau"'},xn="\u03c4",Cn={type:"literal",value:"\u03c4",description:'"\\u03C4"'},wn="|",bn={type:"literal",value:"|",description:'"|"'},An="\u2016",Pn={type:"literal",value:"\u2016",description:'"\\u2016"'},_n="+",zn={type:"literal",value:"+",description:'"+"'},kn="new",$n={type:"literal",value:"new",description:'"new"'},Sn="\u03bd",jn={type:"literal",value:"\u03bd",description:'"\\u03BD"'},En=function(){return D([])},In="zero",Nn={type:"literal",value:"zero",description:'"zero"'},Rn="0",Fn={type:"literal",value:"0",description:'"0"'},On={type:"other",description:"spaces"},Tn=/^[ \n\t]/,Ln={type:"class",value:"[ \\n\\t]",description:"[ \\n\\t]"},Gn={type:"other",description:"space"},qn={type:"other",description:"comment"},Wn="/*",Zn={type:"literal",value:"/*",description:'"/*"'},Un="*/",Mn={type:"literal",value:"*/",description:'"*/"'},Hn={type:"any",description:"any character"},Bn="//",Dn={type:"literal",value:"//",description:'"//"'},Jn=/^[^\n]/,Kn={type:"class",value:"[^\\n]",description:"[^\\n]"},Yn="\n",Qn={type:"literal",value:"\n",description:'"\\n"'},Vn=0,Xn=0,te=[{line:1,column:1,seenCR:!1}],ne=0,ee=[],re=0,oe;if("startRule"in V){if(!(V.startRule in nt))throw new Error("Can't start parsing from rule \""+V.startRule+'".');et=nt[V.startRule]}if(oe=et(),oe!==tt&&Vn===t.length)return oe;throw oe!==tt&&Vn<t.length&&c({type:"end",description:"end of input"}),u(null,ee,ne<t.length?t.charAt(ne):null,ne<t.length?s(ne,ne+1):s(ne,ne))}return t(n,Error),{SyntaxError:n,parse:e}}(),function(){function lookup(t){for(var n=arguments.length-1;!(1>n||t in arguments[n]);)n--;if(1>n)throw Error("Unknown name "+t);return arguments[n][t]}function compile(txt){var ast=txt;"string"==typeof ast&&(ast=parsePi.parse(txt));var prog={defs:{},init:[],sourceCode:txt},defs=ast.defs,cdefs=[];for(var pvar in defs){var comp=defs[pvar].body.components,ccomp=[],fargs={};for(var n in defs[pvar].args)fargs[defs[pvar].args[n]]="x"+n;for(var c in comp)if("input"===comp[c].action.type){var aargs={};for(var n in comp[c].action.args)aargs[comp[c].action.args[n]]="y"+n;var cinp="Receive("+fargs[comp[c].action.channel]+", ";cinp+="function("+comp[c].action.args.map(function(t,n){return"y"+n}).join(",")+") {\n";var procs,cargs={};if("New"===comp[c].cont.type){var ns=comp[c].cont.names;for(var n in ns)cargs[ns[n].name]="z"+n,cinp+="var z"+n+' = new Channel("'+ns[n].name+'");\n';procs=comp[c].cont.proc.components}else{if("Parall"!==comp[c].cont.type)throw Error("Expecting a normalised process! line: "+comp[c].action.loc.start.line);procs=comp[c].cont.components}var cconts=[];for(var pc in procs){if("PiCall"!==procs[pc].type)throw Error("Unexpected "+procs[pc].type+" at line "+procs[pc].loc.start.line);var callargs=procs[pc].args;for(var a in callargs)callargs[a]=lookup(callargs[a],fargs,aargs,cargs);cconts.push("ProcCall('"+procs[pc].pvar+"', ["+callargs.join(",")+"])")}cinp+="return [\n"+cconts.join(",")+"\n];})",ccomp.push(cinp)}else if("output"===comp[c].action.type){
var cout="Send("+fargs[comp[c].action.channel]+", [",aargs=[];for(var n in comp[c].action.args)aargs.push(lookup(comp[c].action.args[n],fargs));if(cout+=aargs.join(",")+"]",comp[c].cont&&("Parall"!==comp[c].cont.type||comp[c].cont.components.length>0)){cout+=", function() {\n";var procs,cargs={};if("New"===comp[c].cont.type){var ns=comp[c].cont.names;for(var n in ns)cargs[ns[n].name]="z"+n,cout+="var z"+n+' = new Channel("'+ns[n].name+'");\n';procs=comp[c].cont.proc.components}else{if("Parall"!==comp[c].cont.type)throw Error("Expecting a normalised process! line: "+comp[c].action.loc.start.line);procs=comp[c].cont.components}var cconts=[];for(var pc in procs){if("PiCall"!==procs[pc].type)throw Error("Unexpected "+procs[pc].type+" at line "+procs[pc].loc.start.line);var callargs=procs[pc].args;for(var a in callargs)callargs[a]=lookup(callargs[a],fargs,cargs);cconts.push("ProcCall('"+procs[pc].pvar+"', ["+callargs.join(",")+"])")}cout+="return [\n"+cconts.join(",")+"\n];}"}cout+=")",ccomp.push(cout)}else if("tau"===comp[c].action.type){var cout="Tau(";if(comp[c].cont&&("Parall"!==comp[c].cont.type||comp[c].cont.components.length>0)){cout+="function() {\n";var procs,cargs={};if("New"===comp[c].cont.type){var ns=comp[c].cont.names;for(var n in ns)cargs[ns[n].name]="z"+n,cout+="var z"+n+' = new Channel("'+ns[n].name+'");\n';procs=comp[c].cont.proc.components}else{if("Parall"!==comp[c].cont.type)throw Error("Expecting a normalised process! line: "+comp[c].action.loc.start.line);procs=comp[c].cont.components}var cconts=[];for(var pc in procs){if("PiCall"!==procs[pc].type)throw Error("Unexpected "+procs[pc].type+" at line "+procs[pc].loc.start.line);var callargs=procs[pc].args;for(var a in callargs)callargs[a]=lookup(callargs[a],fargs,cargs);cconts.push("ProcCall('"+procs[pc].pvar+"', ["+callargs.join(",")+"])")}cout+="return [\n"+cconts.join(",")+"\n];}"}cout+=")",ccomp.push(cout)}var alt="function(";alt+=defs[pvar].args.map(function(t,n){return"x"+n}).join(","),alt+="){return Alt([\n",alt+=ccomp.join(",\n"),alt+="\n]);}",cdefs.push("'"+pvar+"': "+alt)}prog.init=collect_procs(ast.start);var str_defs="PiDefs({"+cdefs.join(",\n")+"})";return prog.defs=eval(str_defs),prog}function collect_procs(t,n,e){if(n=n||{},e=e||{},"New"===t.type){var r=$.extend({},e);for(var o in t.names)r[t.names[o].name]=new Channel(t.names[o].name);return collect_procs(t.proc,n,r)}if("Parall"===t.type){var i=[];for(var a in t.components){var s=collect_procs(t.components[a],n,e);i=i.concat(s)}return i}if("PiCall"===t.type){var c=t.args;for(var u in c)try{c[u]=lookup(c[u],n,e)}catch(l){n[c[u]]=new Channel(c[u],!0),c[u]=n[c[u]]}return[ProcCall(t.pvar,c)]}if("Alt"===t.type)throw Error("Sums not supported at top level. Wrap them in definitions.")}function stxerr(t,n){var e=new Error(t);return e.location=n,e}function validate_syntax(t){for(var n in t.defs){var e=t.defs[n].body;if("Alt"!==e.type)throw stxerr("Normalise your definitions! Your definition for "+n+" does not have a sum at the top level.",e.loc);for(var r in e.components)check_free_names(e.components[r],t.defs[n].args)}}function check_free_names(t,n){if("New"===t.type)check_free_names(t.proc,n.concat(t.names.map(function(t){return t.name})));else if("PiCall"===t.type){for(var e in t.args)if(n.indexOf(t.args[e])<0)throw stxerr("Name '"+t.args[e]+"' out of scope.",t.loc)}else if("Parall"===t.type)for(var e in t.components)check_free_names(t.components[e],n);else{if("Alt"===t.type)throw stxerr("Normalize your code! Sums only allowed at the top-level of a definition!",t.loc);if(void 0!==t.action)if("tau"===t.action.type)check_free_names(t.cont,n);else{if(n.indexOf(t.action.channel)<0)throw stxerr("Name '"+t.action.channel+"' out of scope.",t.loc);if("input"===t.action.type)check_free_names(t.cont,n.concat(t.action.args));else if("output"===t.action.type){for(var e in t.args)if(n.indexOf(t.args[e])<0)throw stxerr("Name '"+t.args[e]+"' out of scope.",t.loc);check_free_names(t.cont,n)}}}}window.parsePi.compile=compile,window.parsePi.validate=validate_syntax,window.parsePi.compileAndCheck=function(t){return t=parsePi.parse(t),validate_syntax(t),compile(t)}}();var gistUrlPattern=/^(https?:\/\/)?gist\.github\.com.*\/([a-zA-Z0-9]*)$/,Stargazer=function(){function t(e,i,a){function s(){$(h.node()).height(function(){return $(this).parent().innerHeight()}).width(function(){return $(this).parent().innerWidth()}).attr("width",function(){return $(this).width()}).attr("height",function(){return $(this).height()}),u&&u.translate([h.attr("width")/2,h.attr("height")/2])}function c(){n(f.node())?z.freeze():z.unfreeze()}if(!(this instanceof t))return new t(e,i,a);a=$.extend({zoom:1,delay:500,gravity:!0,showLabels:!0,playOnLoad:!1,autoFreeze:!0,autoResize:!0},a);var u,l=+a.zoom,p=a.palette?{palette:a.palette}:void 0,f=d3.select(e);f.selectAll(o).remove(),f.append("svg").classed(r,!0);var h=f.select(o);f.datum(this),void 0===i&&(i="0");var d=i,v=parsePi.compileAndCheck(d);u=PiCalcSimulation(h,v,p),u.scale(l);for(var g=10;g>0;--g)u.layout().tick();this.simulator=function(){return u},this.program=function(t){return void 0===t?d:(v=parsePi.compileAndCheck(t),d=t,this.reset(),void 0)},this.resizeCanvas=s,a.autoResize&&($(f.node()).on("div-resize",s),s()),this.gravity=function(t){return void 0===t?u.layout().gravity()>.05:void(t?u.layout().gravity(.2).charge(-400).start():u.layout().gravity(1e-5).charge(-30).start())},this.gravity(a.gravity);var m=function(){return u.next(u.randomStrategy),this};this.step=m;var y=a.delay,x,C=!1,w=!1;this.running=function(){return C},this.delay=function(){return y};var b=$("<div class='controls'></div>").appendTo(f.node()),A=$("<div class='control play'></div>").click(function(){C?z.pause():z.play()}).appendTo(b),P=$("<div class='control open'></div>").click(function(){z.pause(),window.open(a.link||"index.html?program="+encodeURIComponent(d))}).appendTo(b),_=$("<div class='control reset'></div>").click(function(){z.reset()}).appendTo(b);this.play=function(t){return!C||void 0!==t&&+t!==y?(void 0!==t&&(y=+t),clearInterval(x),w||(x=setInterval(m,y)),A.removeClass("play").addClass("pause"),C=!0,this):this},this.delay=function(t){return void 0===t?y:(C?this.play(t):y=+t,this)},this.pause=function(){return clearInterval(x),A.removeClass("pause").addClass("play"),C=!1,this},this.freeze=function(){return w=!0,clearInterval(x),this},this.unfreeze=function(){return C&&w&&(x=setInterval(m,y)),w=!1,this},this.reset=function(){return this.pause(),h.selectAll("*").remove(),u=PiCalcSimulation(h,v,p),u.scale(l),this},a.playOnLoad&&this.play();var z=this;this.autoFreeze=c,a.autoFreeze&&$(f.node()).on("view-change",c),this.showLabels=function(t){return 0===arguments.length?h.classed("labels"):(h.classed("labels",t),this)},this.toggleLabels=function(){return h.classed("labels",!h.classed("labels")),this},this.showGlobals=function(t){return 0===arguments.length?h.classed("globals"):(h.classed("globals",t),this)},this.toggleGlobals=function(){return h.classed("globals",!h.classed("globals")),this},a.showLabels&&this.showLabels(a.showLabels),a.showGlobals&&this.showLabels(a.showGlobals)}function n(t){var n=t.getBoundingClientRect(),e=$(window),r=e.height(),o=e.width();return n.right<0||n.bottom<0||n.top>r||n.left>o}var e=/^(.*)_(\d*)$/,r="stargazer-viz",o="svg."+r;return t}();$(function(){function t(t,n){var e;return function(){clearTimeout(e),e=setTimeout(t,n||250)}}var n=function(){function t(t,n){t.name=t.name||n["default"],t.sourceCode=n.programs[t.name].sourceCode,t.options=$.extend({},n.programs[t.name].options,t.options),t.options.link=e+"?gist="+encodeURIComponent(t.sourceId)+"#"+t.name}function n(n,e){var o={name:void 0,sourceCode:"0",source:"none",sourceId:"",options:{}};o.options.gravity="true"===n.attr("data-gravity");var i=n.attr("data-palette");if(i&&(o.options.palette={},i.split(";").map(function(t){var n=t.split(":");return[n[0].trim(),n[1].trim()]}).each(function(t){o.options.palette[t[0]]=t[1]})),o.options.showLabels="true"===n.attr("data-labels")||n.hasClass("labels"),o.options.showGlobals="true"===n.attr("data-globals")||n.hasClass("globals"),o.options.playOnLoad="true"===n.attr("data-play-on-load"),o.options.delay=n.attr("data-delay"),o.options.zoom=n.attr("data-zoom"),o.name=n.attr("data-program"),n.attr("data-gist")){if(o.source="gist",o.sourceId=n.attr("data-gist"),!(o.sourceId in r))return suiteFromGist(o.sourceId,function(i){return i&&i.successful?(r[o.sourceId]=i,t(o,i),e(o)):void n.addClass("error")});t(o,r[o.sourceId])}else n.find('script[type="text/x-stargazer"]').size()>0?(o.source="inline-script",o.sourceCode=n.find('script[type="text/x-stargazer"]').text()):$('script[type="text/x-stargazer"]#'+o.name).size()>0&&(o.source="script",o.sourceCode=$('script[type="text/x-stargazer"]#'+o.name).text());setTimeout(function(){return e(o)},0)}var e="http://stargazer.emanueledosualdo.com",r={};return n}();$("div.stargazer").each(function(t){var e=$(this),r=this;e.addClass("loading").removeClass("error"),n(e,function(t){e.removeClass("loading");try{Stargazer(r,t.sourceCode,t.options)}catch(n){e.addClass("program error")}})}),$(window).resize(t(function(){$("div.stargazer").trigger("div-resize")})),$(window).scroll(t(function(){$("div.stargazer").trigger("view-change")}))});