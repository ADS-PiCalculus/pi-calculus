"use strict";function suiteFromGist(t,n){var e={source:"gist",successful:!0,programs:{}},r,o=function(){if(e.successful===!0){e.url=r.html_url;var t;try{t=JSON.parse(r.files["default.json"].content)}catch(o){t={}}t["default"]&&t["default"]+".pi"in r.files&&(e["default"]=t["default"]),delete t["default"];for(var i in r.files)if(i.endsWith(".pi")){var a=i.slice(0,-3);if(e.programs[a]={name:a,sourceCode:r.files[i].content,options:$.extend({},t)},a+".json"in r.files)try{$.extend(e.programs[a].options,JSON.parse(r.files[a+".json"].content))}catch(o){console.log("Warning",o)}}var s=Object.keys(e.programs);s.length<1?(e.successful=!1,e.error="empty",e.reason="This suite is empty. A program suite must contain at least one program."):e["default"]||(e["default"]=Object.keys(e.programs)[0])}return n(e)};if("string"!=typeof t)return t.files?(r=t,e.source="stored-gist",e.description=r.description,o()):(e.error="Wrong parameters",n(e));e.id=t;var i=t.match(gistUrlPattern);i?t="https://api.github.com/gists/"+i[2]:t.startsWith("http")||(t="https://api.github.com/gists/"+t),$.ajax(t,{cache:!0,success:function(t){if(r=t,t.truncated===!0)return e.error="truncated",e.reason="The gist is too big",o();e.description=t.description;var n=0,i=0;for(var a in t.files)i++,t.files[a].truncated?$.ajax(t.files[a].raw_url,{success:function(t){return function(n){t.content=n,t.truncated=!1}}(t.files[a]),complete:function(t,r){return n++,n===i?(e.successful=e.successful&&"success"===r,o()):void 0}}):n++;return n===i?o():void 0},error:function(t,n,r){return e.successful=!1,e.error=n,e.reason=r,o()}})}function suiteSize(t){return Object.keys(t.programs).length}function createGistFromSuite(t,n,e){var r={description:t.description,"public":!1,files:{}};for(var o in t.programs)r.files[o+".pi"]={content:t.programs[o].sourceCode},$.isEmptyObject(t.programs[o].options)||(r.files[o+".json"]={content:JSON.stringify(t.programs[o].options)});return $.ajax({url:"https://api.github.com/gists",type:"POST",data:JSON.stringify(r),success:n,error:e}),r}var Channel=function(){function t(e,r){return this instanceof t?(this.name=e,this.global=r===!0,n[e]||(n[e]=0),this.unique=n[e],void n[e]++):new t(e,r)}var n={};return t.prototype.toPiCalc=function(){return this.global===!0?this.name:this.name+"_"+this.unique},t.prototype.is=function(t){return this===t},t.prototype.toString=function(){return this.name+"#"+this.unique},t}(),ProcCall=function(){function t(e,r,o){return this instanceof t?(this.proc_name=e,this.args=r||[],this.unique=n++,void(o&&(this.x=o.x,this.y=o.y,this.fixed=o.fixed))):new t(e,r,o)}var n=0;return t.prototype.toPiCalc=function(){return this.proc_name+"["+this.args.map(function(t){return t.toPiCalc()}).join(",")+"]"},t}(),Action=function(){function t(){return this instanceof t?void 0:new t}return t}(),Tau=function(){function t(n){return this instanceof t?void(this.continuation=n):new t(n)}return t.prototype=new Action,t.prototype.constructor=t,t.prototype.fire=function(){return this.continuation instanceof Function?this.continuation():void 0},t.prototype.toPiCalc=function(){return"\u03c4..."},t}(),Receive=function(){function t(n,e){return this instanceof t?(this.channel=n,this.continuation=e||function(){},void(this.arity=e.length)):new t(n,e)}return t.prototype=new Action,t.prototype.constructor=t,t.prototype.fire=function(t){return this.continuation instanceof Function?this.continuation.apply(null,t):void 0},t.prototype.toPiCalc=function(){for(var t=[],n=0;n<this.arity;n++)t.push("_");return this.channel.toPiCalc()+"?("+t.join(",")+")..."},t}(),Send=function(){function t(n,e,r){return this instanceof t?(this.channel=n,this.args=e||[],this.arity=this.args.length,void(this.continuation=r)):new t(n,e,r)}return t.prototype=new Action,t.prototype.constructor=t,t.prototype.fire=function(){return this.continuation instanceof Function?this.continuation():void 0},t.prototype.toPiCalc=function(){return this.channel.toPiCalc()+"!("+this.args.map(function(t){return t.toPiCalc()}).join(",")+")..."},t}(),Alt=function(){function t(n){return this instanceof t?void(this.alts=n||[]):new t(n)}return t.prototype.enabled_on=function(t,n){return this.waiting_on(t).length>0},t.prototype.waiting_on=function(t,n){return this.receiving_on(t).concat(this.sending_on(t))},t.prototype.receiving_on=function(t,n){return this.alts.filter(function(e){if(e instanceof Receive){var r=void 0==n||e.arity==n;return e.channel.is(t)&&r}return!1})},t.prototype.sending_on=function(t,n){return this.alts.filter(function(e){if(e instanceof Send){var r=void 0==n||e.arity==n;return e.channel.is(t)&&r}return!1})},t.prototype.taus=function(){return this.alts.filter(function(t){return t instanceof Tau})},t.prototype.toPiCalc=function(){return"("+this.alts.map(function(t){return t.toPiCalc()}).join(" + ")+")"},t}(),Zero=void 0,PiDefs=function(){function t(n){return this instanceof t?void(this.defs=n):new t(n)}return t.prototype.unfold=function(t){if(t.proc_name in this.defs){var n=this.defs[t.proc_name];return n.length!==t.args.length?Zero:n.apply(n,t.args)}return Zero},t}(),Config=function(){function t(n,e){return this instanceof t?(this.defs=n,this.names_index={},this.init=e,this.nodes=[],this.procsIndex=0,this.epoch=0,this.links=[],this.mergeCalls(e,{x:0,y:0}),void this.recomputeLinks()):new t(n,e)}function n(t){var n=60;return t+Math.random()*n-n/2}function e(t,n){return void 0!=t&&"x"in t&&"y"in t?void 0!=n&&"x"in n&&"y"in n?{x:(t.x+n.x)/2,y:(t.y+n.y)/2}:{x:t.x,y:t.y}:void 0}function r(t){for(var n=t.length,e,r;n;)r=Math.floor(Math.random()*n--),e=t[n],t[n]=t[r],t[r]=e;return t}t.prototype.mergeCalls=function(t,e){var r=[],o=[],i=this;return void 0==t?{names:[],procs:[]}:(e=e||{x:0,y:0},t.forEach(function(t){if(t){t.args.forEach(function(t){t in i.names_index||(i.names_index[t]={refCount:0,age:0},void 0!=e&&(t.x=n(e.x),t.y=n(e.y)),r.push(t)),i.names_index[t].refCount++});var a={call:t,body:i.defs.unfold(t),age:i.epoch};void 0!==t.x&&void 0!==t.y?(a.x=t.x,a.y=t.y,t.fixed&&(a.fixed=!0)):void 0!=e&&(a.x=n(e.x),a.y=n(e.y)),o.push(a)}}),this.nodes.unshift.apply(this.nodes,r),this.nodes.push.apply(this.nodes,o),this.procsIndex+=r.length,{names:r,procs:o})},t.prototype.addCalls=function(t){"string"==typeof t&&(t=t.split("|"));for(var n,e=[],r=0;r<t.length;r++)try{for(var o=t[r].trim().split("["),i=o[0],a=o[1].split("]")[0].split(",").map(function(t){return t.trim()}),s=this.getNames(),c=0;c<a.length;c++){var u=s.find(function(t){return t.toPiCalc()==a[c]});u?a[c]=u:(u=e.find(function(t){return t.name==a[c]}),u?a[c]=u:(a[c]=Channel(a[c]),e.push(a[c])))}t[r]=ProcCall(i,a)}catch(l){return console.log(l),!1}return this.mergeCalls(t,n),this.recomputeLinks(),!0},t.prototype.gcNames=function(){for(var t in this.names_index)this.names_index[t].refCount<=0&&delete this.names_index[t];for(var n=0;n<this.procsIndex;)this.nodes[n]in this.names_index?n++:(this.nodes.splice(n,1),this.procsIndex--)},t.prototype.redexes=function(){for(var t=this.procsIndex,n=[];t<this.nodes.length;){if(this.nodes[t].body){var e=this.nodes[t];n=n.concat(e.body.taus().map(function(n){return{type:"tau",index:t,action:n,process:e}}))}t++}for(var r=[],o=0;o<this.procsIndex;){for(var i=[],a=[],t=this.procsIndex;t<this.nodes.length;){if(this.nodes[t].body){var e=this.nodes[t],s=e.body.receiving_on(this.nodes[o]),c=e.body.sending_on(this.nodes[o]);s.forEach(function(n){a.push({index:t,action:n,process:e})}),c.forEach(function(n){i.push({index:t,action:n,process:e})})}t++}for(var u=0,l=!1;u<i.length;){for(var p=0;p<a.length;){var f=i[u],h=a[p];f.index!=h.index&&f.action.arity==h.action.arity&&(r.push({type:"comm",sender:f,receiver:h}),l=!0),p++}u++}l?this.names_index[this.nodes[o]].age++:this.names_index[this.nodes[o]].age=0,o++}return n.concat(r)};var o=function(t){return{pick:function(n){r(n);for(var e=t.epoch+1,o,i=n.length-1;i>=0;i--){var a;a="tau"==n[i].type?t.nodes[n[i].index].age:Math.min(t.nodes[n[i].sender.index].age,t.nodes[n[i].receiver.index].age),e>=a&&(e=a,o=i)}return void 0!=o?n[o]:void 0}}};return t.prototype.next=function(t){void 0==t&&(t=o(this));var n=this.redexes();if(n.length<=0)return!1;var e=t.pick(n);return void 0==e?!1:(this.makeReact(e),!0)},t.prototype.makeReact=function(n){if("tau"==n.type){var r=e(this.nodes[n.index]),o=n.action.fire();t.heritage(this.nodes[n.index],o),this.removeProc(n.index),this.mergeCalls(o,r)}else{var r=e(this.nodes[n.sender.index],this.nodes[n.receiver.index]),i=n.sender.action.fire(),a=n.receiver.action.fire(n.sender.action.args),s=n.sender.index,c=n.receiver.index;t.heritage(this.nodes[s],i),t.heritage(this.nodes[c],a),this.removeProc(s>c?s:c),this.removeProc(s>c?c:s),this.mergeCalls(i,r),this.mergeCalls(a,r)}return this.gcNames(),this.recomputeLinks(),this.epoch++,this},t.heritage=function(t,n){if(t&&n&&0!==n.length){var e=n[0];e.x=t.x,e.y=t.y,t.fixed&&(e.fixed=!0)}},t.prototype.removeProc=function(t){if(t>=this.nodes.length||t<this.procsIndex)return!1;var n=this.names_index;return this.nodes[t].call.args.forEach(function(t){n[t].refCount--}),this.nodes.splice(t,1),!0},t.prototype.getNames=function(){return this.nodes.slice(0,this.procsIndex)},t.prototype.getProcs=function(){return this.nodes.slice(this.procsIndex)},t.prototype.recomputeLinks=function(){var t=this.links;t.splice(0,this.links.length);for(var n=this.procsIndex;n<this.nodes.length;n++){var e=this.nodes[n];e.call.args.forEach(function(n){t.push({source:e,target:n})})}},t.prototype.toPiCalc=function(){var t="",n=this.getNames().filter(function(t){return t.global!==!0}),e=this.getProcs();return n.length>0&&(t+="\u03bd"+n.map(function(t){return t.toPiCalc()}).join(",")+"."),e.length>0?(e.length>1&&(t+="( "),t+=e.map(function(t){return t.call.toPiCalc()}).join(" | "),e.length>1&&(t+=" )")):t+="0",t},t}(),PiCalcSimulation=function(){function t(o,i,a){function s(t){return h[t]||(d++,h[t]=n(d)),h[t]}function c(t){d3.event.altKey&&d3.select(this).classed("fixed",t.fixed=!t.fixed)}if(!(this instanceof t))return new t(o,i,a);var u=i.defs,l=i.init,p=Config(u,l);this.q=p,a=a||{};for(var f in e)e.hasOwnProperty(f)&&!a.hasOwnProperty(f)&&(a[f]=e[f]);this.options=a;var h={Ghost:"white"},d=0;for(var v in a.palette)h[v]=a.palette[v];for(var v in u.defs)s(v);var g=d3.layout.force().charge(-400).linkDistance(function(t){return t.target.global?100:30}).linkStrength(function(t){return t.target.global?.01:.9}).friction(.8).nodes(p.nodes).links(p.links);this.layout=function(){return g};var m=o;o=o.append("g"),o.append("g").attr("id","links"),o.append("g").attr("id","nodes"),o.append("g").attr("id","labels");var y=o.select("#links").selectAll(".link"),x=o.select("#nodes").selectAll(".node .name"),C=o.select("#nodes").selectAll(".node .seq"),A=o.select("#labels").selectAll(".lbl"),w=o.select("#labels").selectAll(".name-lbl"),b=d3.behavior.zoom().scaleExtent([-10,10]).translate([m.attr("width")/2,m.attr("height")/2]).on("zoom",function(){o.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")});m.call(b),this.translate=function(){return arguments.length>0?b.translate.apply(b,arguments).event(o):b.translate()},this.scale=function(){return arguments.length>0?b.scale.apply(b,arguments).event(o):b.scale()},this.zoom=function(){return b},this.legend=function(){var t=[];for(var n in h)"Ghost"!==n&&t.push({name:n,color:h[n]});return t};var P=g.drag().on("dragstart",function(){d3.event.sourceEvent.stopPropagation()});this.update=function(){y=y.data(p.links),x=x.data(p.getNames(),function(t){return t.toString()}),C=C.data(p.getProcs(),function(t){return t.call.unique}),A=A.data(p.getProcs(),function(t){return t.call.unique}),w=w.data(p.getNames(),function(t){return t.toString()}),y.exit().remove(),y.enter().append("line").classed("link",!0),y.classed("global",function(t){return t.target.global}),A.exit().remove(),A.enter().append("text").attr("class","lbl").text(function(t){return t.color=s(t.call.proc_name),"Ghost"===t.call.proc_name?"":t.call.proc_name}),w.exit().remove(),w.enter().append("text").attr("class","nlbl").classed("global",function(t){return t.global}).html(function(t){return t.toPiCalc().replace(r,'$1 <tspan dy=".3em" dx="-.9em" style="font-size:60%">$2</tspan>')}),x.exit().remove(),x.classed("fixed",function(t){return t.fixed}),x.enter().append("circle").classed({node:!0,name:!0}).classed("global",function(t){return t.global}).attr("r",a.nameSize).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).on("click",c).call(P).append("title").text(function(t){return t.toPiCalc()});var t=a.procWidth/2,n=a.procHeight/2;return C.exit().remove(),C.enter().append("rect").attr("class","node seq").attr("width",a.procWidth).attr("height",a.procHeight).attr("x",function(n){return n.x-t}).attr("y",function(t){return t.y-n}).classed("fixed",function(t){return t.fixed}).style("fill",function(t){return t.color}).on("click",function(t){console.info(t.call.toPiCalc(),t.x,t.y)}).on("click",c).call(P).append("title").text(function(t){return t.call.toPiCalc()}),g.start(),this};var _=void 0;this.init=function(t){return _=t,this};var z=function(t){return t.x},k=function(t){return t.y};g.on("tick",function(){var t=a.procWidth/2,n=a.procHeight/2,e=z,r=k;if(void 0!=a.collapse){var o;e=function(t){return t instanceof Channel&&t.name==a.collapse?(void 0==o&&(o=t),o.x):t.x},r=function(t){return t instanceof Channel&&t.name==a.collapse?(void 0==o&&(o=t),o.y):t.y}}y.attr("x1",function(t){return e(t.source)}).attr("y1",function(t){return r(t.source)}).attr("x2",function(t){return e(t.target)}).attr("y2",function(t){return r(t.target)}),x.attr("cx",e).attr("cy",r),A.attr("x",function(t){return e(t)}).attr("y",function(t){return r(t)-a.procHeight}),w.attr("x",function(t){return e(t)}).attr("y",function(t){return r(t)-a.nameSize-5}),C.attr("x",function(n){return n.x-t}).attr("y",function(t){return t.y-n}),_&&(_(),_=void 0)}),this.update(),b.event(o)}var n=d3.scale.category20(),e={nameSize:5,procWidth:18,procHeight:12},r=/^(.*)_(\d*)$/;return t.prototype.randomStrategy={pick:function(t){return t[Math.floor(Math.random()*t.length)]}},t.prototype.next=function(t){return this.q.next(t)?(this.update(),!0):!1},t}();window.parsePi=function(){function t(t,n){function e(){this.constructor=t}e.prototype=n.prototype,t.prototype=new e}function n(t,e,r,o){this.message=t,this.expected=e,this.found=r,this.location=o,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,n)}function e(t){function e(){return t.substring(pe,le)}function r(){return s(pe,le)}function o(n){throw u(null,[{type:"other",description:n}],t.substring(pe,le),s(pe,le))}function i(n){throw u(n,null,t.substring(pe,le),s(pe,le))}function a(n){var e=fe[n],r,o;if(e)return e;for(r=n-1;!fe[r];)r--;for(e=fe[r],e={line:e.line,column:e.column,seenCR:e.seenCR};n>r;)o=t.charAt(r),"\n"===o?(e.seenCR||e.line++,e.column=1,e.seenCR=!1):"\r"===o||"\u2028"===o||"\u2029"===o?(e.line++,e.column=1,e.seenCR=!0):(e.column++,e.seenCR=!1),r++;return fe[n]=e,e}function s(t,n){var e=a(t),r=a(n);return{start:{offset:t,line:e.line,column:e.column},end:{offset:n,line:r.line,column:r.column}}}function c(t){he>le||(le>he&&(he=le,de=[]),de.push(t))}function u(t,e,r,o){function i(t){var n=1;for(t.sort(function(t,n){return t.description<n.description?-1:t.description>n.description?1:0});n<t.length;)t[n-1]===t[n]?t.splice(n,1):n++}function a(t,n){function e(t){function n(t){return t.charCodeAt(0).toString(16).toUpperCase()}return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(t){return"\\x0"+n(t)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(t){return"\\x"+n(t)}).replace(/[\u0100-\u0FFF]/g,function(t){return"\\u0"+n(t)}).replace(/[\u1000-\uFFFF]/g,function(t){return"\\u"+n(t)})}var r=new Array(t.length),o,i,a;for(a=0;a<t.length;a++)r[a]=t[a].description;return o=t.length>1?r.slice(0,-1).join(", ")+" or "+r[t.length-1]:r[0],i=n?'"'+e(n)+'"':"end of input","Expected "+o+" but "+i+" found."}return null!==e&&i(e),new n(null!==t?t:a(e,r),e,r,o)}function l(){var t,n,e,r,o;return t=le,n=M(),n!==rt?(e=p(),e!==rt?(r=M(),r!==rt?(o=f(),o!==rt?(pe=t,n=at(e,o),t=n):(le=t,t=rt)):(le=t,t=rt)):(le=t,t=rt)):(le=t,t=rt),t}function p(){var t,n;return t=le,n=d(),n!==rt&&(pe=t,n=st(n)),t=n}function f(){var t,n,e,r,o;for(t=le,n=[],e=le,r=h(),r!==rt?(o=M(),o!==rt?(pe=e,r=ct(r),e=r):(le=e,e=rt)):(le=e,e=rt);e!==rt;)n.push(e),e=le,r=h(),r!==rt?(o=M(),o!==rt?(pe=e,r=ct(r),e=r):(le=e,e=rt)):(le=e,e=rt);return n!==rt&&(pe=t,n=ut(n)),t=n}function h(){var n,e,r,o,i,a;return ve++,n=le,e=S(),e!==rt?(r=M(),r!==rt?(t.substr(le,2)===pt?(o=pt,le+=2):(o=rt,0===ve&&c(ft)),o!==rt?(i=M(),i!==rt?(a=d(),a!==rt?(pe=n,e=ht(e,a),n=e):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt),ve--,n===rt&&(e=rt,0===ve&&c(lt)),n}function d(){var t,n,e,r,o,i,a,s;if(ve++,t=le,n=v(),n!==rt){for(e=[],r=le,o=M(),o!==rt?(i=G(),i!==rt?(a=M(),a!==rt?(s=v(),s!==rt?(pe=r,o=vt(n,s),r=o):(le=r,r=rt)):(le=r,r=rt)):(le=r,r=rt)):(le=r,r=rt);r!==rt;)e.push(r),r=le,o=M(),o!==rt?(i=G(),i!==rt?(a=M(),a!==rt?(s=v(),s!==rt?(pe=r,o=vt(n,s),r=o):(le=r,r=rt)):(le=r,r=rt)):(le=r,r=rt)):(le=r,r=rt);e!==rt?(pe=t,n=gt(n,e),t=n):(le=t,t=rt)}else le=t,t=rt;return ve--,t===rt&&(n=rt,0===ve&&c(dt)),t}function v(){var n,e,r,o,i,a;return ve++,n=Z(),n===rt&&(n=g(),n===rt&&(n=le,e=j(),e!==rt&&(pe=n,e=mt(e)),n=e,n===rt&&(n=le,e=P(),e!==rt&&(pe=n,e=mt(e)),n=e,n===rt&&(n=le,40===t.charCodeAt(le)?(e=yt,le++):(e=rt,0===ve&&c(xt)),e!==rt?(r=M(),r!==rt?(o=d(),o!==rt?(i=M(),i!==rt?(41===t.charCodeAt(le)?(a=Ct,le++):(a=rt,0===ve&&c(At)),a!==rt?(pe=n,e=wt(o),n=e):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt),n===rt&&(n=le,e=x(),e!==rt&&(pe=n,e=bt(e)),n=e))))),ve--,n===rt&&(e=rt,0===ve&&c(dt)),n}function g(){var t,n,e;return ve++,t=le,n=S(),n!==rt?(e=m(),e===rt&&(e=null),e!==rt?(pe=t,n=_t(n,e),t=n):(le=t,t=rt)):(le=t,t=rt),ve--,t===rt&&(n=rt,0===ve&&c(Pt)),t}function m(){var n,e,r,o,i,a,s,u,l,p,f,h;return ve++,n=le,64===t.charCodeAt(le)?(e=kt,le++):(e=rt,0===ve&&c($t)),e!==rt?(r=M(),r!==rt?(40===t.charCodeAt(le)?(o=yt,le++):(o=rt,0===ve&&c(xt)),o!==rt?(i=M(),i!==rt?(a=y(),a!==rt?(s=M(),s!==rt?(44===t.charCodeAt(le)?(u=St,le++):(u=rt,0===ve&&c(jt)),u!==rt?(l=M(),l!==rt?(p=y(),p!==rt?(f=M(),f!==rt?(41===t.charCodeAt(le)?(h=Ct,le++):(h=rt,0===ve&&c(At)),h!==rt?(pe=n,e=Et(a,p),n=e):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt),ve--,n===rt&&(e=rt,0===ve&&c(zt)),n}function y(){var n,e,r,o,i,a,s;if(n=le,e=le,It.test(t.charAt(le))?(r=t.charAt(le),le++):(r=rt,0===ve&&c(Nt)),r===rt&&(r=null),r!==rt){for(o=[],Rt.test(t.charAt(le))?(i=t.charAt(le),le++):(i=rt,0===ve&&c(Ft));i!==rt;)o.push(i),Rt.test(t.charAt(le))?(i=t.charAt(le),le++):(i=rt,0===ve&&c(Ft));if(o!==rt)if(46===t.charCodeAt(le)?(i=Ot,le++):(i=rt,0===ve&&c(Tt)),i===rt&&(i=null),i!==rt){for(a=[],Rt.test(t.charAt(le))?(s=t.charAt(le),le++):(s=rt,0===ve&&c(Ft));s!==rt;)a.push(s),Rt.test(t.charAt(le))?(s=t.charAt(le),le++):(s=rt,0===ve&&c(Ft));a!==rt?(r=[r,o,i,a],e=r):(le=e,e=rt)}else le=e,e=rt;else le=e,e=rt}else le=e,e=rt;return n=e!==rt?t.substring(n,le):e}function x(){var t,n,e,r,o,i,a,s;if(t=le,n=C(),n!==rt){for(e=[],r=le,o=M(),o!==rt?(i=q(),i!==rt?(a=M(),a!==rt?(s=C(),s!==rt?(pe=r,o=Lt(n,s),r=o):(le=r,r=rt)):(le=r,r=rt)):(le=r,r=rt)):(le=r,r=rt);r!==rt;)e.push(r),r=le,o=M(),o!==rt?(i=q(),i!==rt?(a=M(),a!==rt?(s=C(),s!==rt?(pe=r,o=Lt(n,s),r=o):(le=r,r=rt)):(le=r,r=rt)):(le=r,r=rt)):(le=r,r=rt);e!==rt?(pe=t,n=Gt(n,e),t=n):(le=t,t=rt)}else le=t,t=rt;return t}function C(){var n,e,r,o,i,a,s;return ve++,n=le,e=_(),e!==rt?(r=M(),r!==rt?(o=le,46===t.charCodeAt(le)?(i=Ot,le++):(i=rt,0===ve&&c(Tt)),i!==rt?(a=M(),a!==rt?(s=w(),s!==rt?(pe=o,i=Wt(e,s),o=i):(le=o,o=rt)):(le=o,o=rt)):(le=o,o=rt),o===rt&&(o=null),o!==rt?(pe=n,e=Zt(e,o),n=e):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt),ve--,n===rt&&(e=rt,0===ve&&c(qt)),n}function A(){var t,n;return t=le,n=C(),n!==rt&&(pe=t,n=Ut(n)),t=n}function w(){var t,n;return ve++,t=Z(),t===rt&&(t=j(),t===rt&&(t=b())),ve--,t===rt&&(n=rt,0===ve&&c(Mt)),t}function b(){var n,e,r,o,i,a;return n=g(),n===rt&&(n=le,40===t.charCodeAt(le)?(e=yt,le++):(e=rt,0===ve&&c(xt)),e!==rt?(r=M(),r!==rt?(o=d(),o!==rt?(i=M(),i!==rt?(41===t.charCodeAt(le)?(a=Ct,le++):(a=rt,0===ve&&c(At)),a!==rt?(pe=n,e=wt(o),n=e):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt),n===rt&&(n=le,e=A(),e!==rt&&(pe=n,e=Ht(e)),n=e)),n}function P(){var n,e,r,o;return ve++,n=le,42===t.charCodeAt(le)?(e=Dt,le++):(e=rt,0===ve&&c(Jt)),e!==rt?(r=M(),r!==rt?(o=b(),o!==rt?(pe=n,e=Kt(o),n=e):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt),ve--,n===rt&&(e=rt,0===ve&&c(Bt)),n}function _(){var t,n;return ve++,t=k(),t===rt&&(t=z(),t===rt&&(t=$())),ve--,t===rt&&(n=rt,0===ve&&c(Yt)),t}function z(){var n,e,r,o,i,a,s,u;return ve++,n=le,e=T(),e!==rt?(r=M(),r!==rt?(40===t.charCodeAt(le)?(o=yt,le++):(o=rt,0===ve&&c(xt)),o!==rt?(i=M(),i!==rt?(a=N(),a===rt&&(a=null),a!==rt?(s=M(),s!==rt?(41===t.charCodeAt(le)?(u=Ct,le++):(u=rt,0===ve&&c(At)),u!==rt?(pe=n,e=Vt(e,a),n=e):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt),ve--,n===rt&&(e=rt,0===ve&&c(Qt)),n}function k(){var n,e,r,o,i,a,s,u;return ve++,n=le,e=T(),e!==rt?(r=M(),r!==rt?(60===t.charCodeAt(le)?(o=tn,le++):(o=rt,0===ve&&c(nn)),o!==rt?(i=M(),i!==rt?(a=N(),a===rt&&(a=null),a!==rt?(s=M(),s!==rt?(62===t.charCodeAt(le)?(u=en,le++):(u=rt,0===ve&&c(rn)),u!==rt?(pe=n,e=on(e,a),n=e):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt),ve--,n===rt&&(e=rt,0===ve&&c(Xt)),n}function $(){var t,n;return t=le,n=L(),n!==rt&&(pe=t,n=an()),t=n}function S(){var t,n,e,r;return t=le,n=O(),n!==rt?(e=M(),e!==rt?(r=I(),r===rt&&(r=null),r!==rt?(pe=t,n=sn(n,r),t=n):(le=t,t=rt)):(le=t,t=rt)):(le=t,t=rt),t}function j(){var n,e,r,o,i,a,s,u;return ve++,n=le,e=W(),e!==rt?(r=M(),r!==rt?(o=E(),o!==rt?(i=M(),i!==rt?(46===t.charCodeAt(le)?(a=Ot,le++):(a=rt,0===ve&&c(Tt)),a!==rt?(s=M(),s!==rt?(u=w(),u===rt&&(u=j()),u!==rt?(pe=n,e=un(o,u),n=e):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt),ve--,n===rt&&(e=rt,0===ve&&c(cn)),n}function E(){var n,e,r,o,i,a;return n=le,40===t.charCodeAt(le)?(e=yt,le++):(e=rt,0===ve&&c(xt)),e!==rt?(r=M(),r!==rt?(o=R(),o!==rt?(i=M(),i!==rt?(41===t.charCodeAt(le)?(a=Ct,le++):(a=rt,0===ve&&c(At)),a!==rt?(pe=n,e=ln(o),n=e):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt),n===rt&&(n=R()),n}function I(){var n,e,r,o,i,a;return ve++,n=le,91===t.charCodeAt(le)?(e=fn,le++):(e=rt,0===ve&&c(hn)),e!==rt?(r=M(),r!==rt?(o=N(),o===rt&&(o=null),o!==rt?(i=M(),i!==rt?(93===t.charCodeAt(le)?(a=dn,le++):(a=rt,0===ve&&c(vn)),a!==rt?(pe=n,e=gn(o),n=e):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt)):(le=n,n=rt),ve--,n===rt&&(e=rt,0===ve&&c(pn)),n}function N(){var n,e,r,o,i,a,s,u;if(ve++,n=le,e=T(),e!==rt)if(r=M(),r!==rt){for(o=[],i=le,44===t.charCodeAt(le)?(a=St,le++):(a=rt,0===ve&&c(jt)),a!==rt?(s=M(),s!==rt?(u=T(),u!==rt?(pe=i,a=yn(e,u),i=a):(le=i,i=rt)):(le=i,i=rt)):(le=i,i=rt);i!==rt;)o.push(i),i=le,44===t.charCodeAt(le)?(a=St,le++):(a=rt,0===ve&&c(jt)),a!==rt?(s=M(),s!==rt?(u=T(),u!==rt?(pe=i,a=yn(e,u),i=a):(le=i,i=rt)):(le=i,i=rt)):(le=i,i=rt);o!==rt?(pe=n,e=xn(e,o),n=e):(le=n,n=rt)}else le=n,n=rt;else le=n,n=rt;return ve--,n===rt&&(e=rt,0===ve&&c(mn)),n}function R(){var n,e,r,o,i,a,s,u;if(ve++,n=le,e=F(),e!==rt)if(r=M(),r!==rt){for(o=[],i=le,44===t.charCodeAt(le)?(a=St,le++):(a=rt,0===ve&&c(jt)),a!==rt?(s=M(),s!==rt?(u=F(),u!==rt?(pe=i,a=yn(e,u),i=a):(le=i,i=rt)):(le=i,i=rt)):(le=i,i=rt);i!==rt;)o.push(i),i=le,44===t.charCodeAt(le)?(a=St,le++):(a=rt,0===ve&&c(jt)),a!==rt?(s=M(),s!==rt?(u=F(),u!==rt?(pe=i,a=yn(e,u),i=a):(le=i,i=rt)):(le=i,i=rt)):(le=i,i=rt);o!==rt?(pe=n,e=xn(e,o),n=e):(le=n,n=rt)}else le=n,n=rt;else le=n,n=rt;return ve--,n===rt&&(e=rt,0===ve&&c(mn)),n}function F(){var t,n;return t=le,n=T(),n!==rt&&(pe=t,n=Cn(n)),t=n}function O(){var n,e,r,o,i;if(ve++,n=le,e=le,wn.test(t.charAt(le))?(r=t.charAt(le),le++):(r=rt,0===ve&&c(bn)),r!==rt){for(o=[],Pn.test(t.charAt(le))?(i=t.charAt(le),le++):(i=rt,0===ve&&c(_n));i!==rt;)o.push(i),Pn.test(t.charAt(le))?(i=t.charAt(le),le++):(i=rt,0===ve&&c(_n));o!==rt?(r=[r,o],e=r):(le=e,e=rt)}else le=e,e=rt;return n=e!==rt?t.substring(n,le):e,ve--,n===rt&&(e=rt,0===ve&&c(An)),n}function T(){var n,e,r,o,i;if(ve++,n=le,e=le,kn.test(t.charAt(le))?(r=t.charAt(le),le++):(r=rt,0===ve&&c($n)),r!==rt){for(o=[],Pn.test(t.charAt(le))?(i=t.charAt(le),le++):(i=rt,0===ve&&c(_n));i!==rt;)o.push(i),Pn.test(t.charAt(le))?(i=t.charAt(le),le++):(i=rt,0===ve&&c(_n));o!==rt?(r=[r,o],e=r):(le=e,e=rt)}else le=e,e=rt;return n=e!==rt?t.substring(n,le):e,ve--,n===rt&&(e=rt,0===ve&&c(zn)),n}function L(){var n;return t.substr(le,3)===Sn?(n=Sn,le+=3):(n=rt,0===ve&&c(jn)),n===rt&&(964===t.charCodeAt(le)?(n=En,le++):(n=rt,0===ve&&c(In))),n}function G(){var n;return 124===t.charCodeAt(le)?(n=Nn,le++):(n=rt,0===ve&&c(Rn)),n===rt&&(8214===t.charCodeAt(le)?(n=Fn,le++):(n=rt,0===ve&&c(On))),n}function q(){var n;return 43===t.charCodeAt(le)?(n=Tn,le++):(n=rt,0===ve&&c(Ln)),n}function W(){var n;return t.substr(le,3)===Gn?(n=Gn,le+=3):(n=rt,0===ve&&c(qn)),n===rt&&(957===t.charCodeAt(le)?(n=Wn,le++):(n=rt,0===ve&&c(Zn))),n}function Z(){var t,n;return t=le,n=U(),n!==rt&&(pe=t,n=Un()),t=n}function U(){var n;return t.substr(le,4)===Mn?(n=Mn,le+=4):(n=rt,0===ve&&c(Hn)),n===rt&&(48===t.charCodeAt(le)?(n=Bn,le++):(n=rt,0===ve&&c(Dn))),n}function M(){var t,n;for(t=[],n=B(),n===rt&&(n=D());n!==rt;)t.push(n),n=B(),n===rt&&(n=D());return t}function H(){var n,e;for(ve++,n=[],Kn.test(t.charAt(le))?(e=t.charAt(le),le++):(e=rt,0===ve&&c(Yn));e!==rt;)n.push(e),Kn.test(t.charAt(le))?(e=t.charAt(le),le++):(e=rt,0===ve&&c(Yn));return ve--,n===rt&&(e=rt,0===ve&&c(Jn)),n}function B(){var n,e;return ve++,Kn.test(t.charAt(le))?(n=t.charAt(le),le++):(n=rt,0===ve&&c(Yn)),ve--,n===rt&&(e=rt,0===ve&&c(Qn)),n}function D(){var n,e,r,o,i,a;if(ve++,n=le,t.substr(le,2)===Xn?(e=Xn,le+=2):(e=rt,0===ve&&c(te)),e!==rt){for(r=[],o=le,i=le,ve++,t.substr(le,2)===ne?(a=ne,le+=2):(a=rt,0===ve&&c(ee)),ve--,a===rt?i=void 0:(le=i,i=rt),i!==rt?(t.length>le?(a=t.charAt(le),le++):(a=rt,0===ve&&c(re)),a!==rt?(i=[i,a],o=i):(le=o,o=rt)):(le=o,o=rt);o!==rt;)r.push(o),o=le,i=le,ve++,t.substr(le,2)===ne?(a=ne,le+=2):(a=rt,0===ve&&c(ee)),ve--,a===rt?i=void 0:(le=i,i=rt),i!==rt?(t.length>le?(a=t.charAt(le),le++):(a=rt,0===ve&&c(re)),a!==rt?(i=[i,a],o=i):(le=o,o=rt)):(le=o,o=rt);r!==rt?(t.substr(le,2)===ne?(o=ne,le+=2):(o=rt,0===ve&&c(ee)),o!==rt?(e=[e,r,o],n=e):(le=n,n=rt)):(le=n,n=rt)}else le=n,n=rt;if(n===rt)if(n=le,t.substr(le,2)===oe?(e=oe,le+=2):(e=rt,0===ve&&c(ie)),e!==rt){for(r=[],ae.test(t.charAt(le))?(o=t.charAt(le),le++):(o=rt,0===ve&&c(se));o!==rt;)r.push(o),ae.test(t.charAt(le))?(o=t.charAt(le),le++):(o=rt,0===ve&&c(se));r!==rt?(10===t.charCodeAt(le)?(o=ce,le++):(o=rt,0===ve&&c(ue)),o===rt&&(o=null),o!==rt?(e=[e,r,o],n=e):(le=n,n=rt)):(le=n,n=rt)}else le=n,n=rt;return ve--,n===rt&&(e=rt,0===ve&&c(Vn)),n}function J(t){return null==t?[]:t}function K(t,n){return n.unshift(t),n}function Y(t){return{type:"Parall",components:t}}function Q(t){return{type:"Alt",components:t,loc:r()}}function V(t){return{type:"Bang",components:t,loc:r()}}function X(t,n){return t.type!=n.type&&i("Merging uncompatible objects "+t.type+" and "+n.type),{type:t.type,components:t.components.concat(n.components)}}function tt(t,n){var e=t;for(var r in n)e=X(e,n[r]);return e}var nt=arguments.length>1?arguments[1]:{},et=this,rt={},ot={start:l},it=l,at=function(t,n){return{start:t,defs:n}},st=function(t){return me=!1,t},ct=function(t){return t},ut=function(t){for(var n={},e=0;e<t.length;e++){var r=t[e].pvar;r in n?i("Multiple definition for "+r):n[r]=t[e].def}return n},lt={type:"other",description:"process definition"},pt=":=",ft={type:"literal",value:":=",description:'":="'},ht=function(t,n){return("Parall"!==n.type||n.components.length>1)&&i("The top level of a definitions should be a sum"),0===n.components.length?n.type="Alt":(n=n.components[0],"Alt"!==n.type&&i("The top level of a definitions should be a sum")),{pvar:t.pvar,def:{args:t.args,body:n}}},dt={type:"other",description:"term"},vt=function(t,n){return n},gt=function(t,n){return tt(t,n)},mt=function(t){return Y([t])},yt="(",xt={type:"literal",value:"(",description:'"("'},Ct=")",At={type:"literal",value:")",description:'")"'},wt=function(t){return t},bt=function(t){return Y([t])},Pt={type:"other",description:"process call"},_t=function(t,n){return t.type="PiCall",null!==n&&(me||i("Position annotation only valid in initial term"),t.x=n[0],t.y=n[1],t.fixed=!0),Y([t])},zt={type:"other",description:"position"},kt="@",$t={type:"literal",value:"@",description:'"@"'},St=",",jt={type:"literal",value:",",description:'","'},Et=function(t,n){return[+t,+n]},It=/^[+\-]/,Nt={type:"class",value:"[+-]",description:"[+-]"},Rt=/^[0-9]/,Ft={type:"class",value:"[0-9]",description:"[0-9]"},Ot=".",Tt={type:"literal",value:".",description:'"."'},Lt=function(t,n){return n},Gt=function(t,n){return Q(K(t,n))},qt={type:"other",description:"factor"},Wt=function(t,n){return n},Zt=function(t,n){return null==n&&(n=Y([])),{action:t,cont:n}},Ut=function(t){return Q([t])},Mt={type:"other",description:"continuation"},Ht=function(t){return Y([t])},Bt={type:"other",description:"replicated process"},Dt="*",Jt={type:"literal",value:"*",description:'"*"'},Kt=function(t){1!=t.components.length&&i("Only guarded replication is supported!");var n=t.components[0];return"Alt"!=n.type&&i("Only guarded replication is supported!"),V(n.components)},Yt={type:"other",description:"action prefix"},Qt={type:"other",description:"input action"},Vt=function(t,n){return{channel:t,type:"input",args:J(n),loc:r()}},Xt={type:"other",description:"output action"},tn="<",nn={type:"literal",value:"<",description:'"<"'},en=">",rn={type:"literal",value:">",description:'">"'},on=function(t,n){return{channel:t,type:"output",args:J(n),loc:r()}},an=function(){return{type:"tau",loc:r()}},sn=function(t,n){return{pvar:t,args:J(n),loc:r()}},cn={type:"other",description:"restriction"},un=function(t,n){return 0==t.length?n:"New"==n.type?{type:"New",names:t.concat(n.names),proc:n.proc}:{type:"New",names:t,proc:n}},ln=function(t){return t},pn={type:"other",description:"arguments list"},fn="[",hn={type:"literal",value:"[",description:'"["'},dn="]",vn={type:"literal",value:"]",description:'"]"'},gn=function(t){return J(t)},mn={type:"other",description:"list of names"},yn=function(t,n){return n},xn=function(t,n){return n.unshift(t),n},Cn=function(t){return{name:t,loc:r()}},An={type:"other",description:"process identifier"},wn=/^[A-Z]/,bn={type:"class",value:"[A-Z]",description:"[A-Z]"},Pn=/^[a-zA-Z0-9'_]/,_n={type:"class",value:"[a-zA-Z0-9'_]",description:"[a-zA-Z0-9'_]"},zn={type:"other",description:"name"},kn=/^[a-z]/,$n={type:"class",value:"[a-z]",description:"[a-z]"},Sn="tau",jn={type:"literal",value:"tau",description:'"tau"'},En="\u03c4",In={type:"literal",value:"\u03c4",description:'"\\u03C4"'},Nn="|",Rn={type:"literal",value:"|",description:'"|"'},Fn="\u2016",On={type:"literal",value:"\u2016",description:'"\\u2016"'},Tn="+",Ln={type:"literal",value:"+",description:'"+"'},Gn="new",qn={type:"literal",value:"new",description:'"new"'},Wn="\u03bd",Zn={type:"literal",value:"\u03bd",description:'"\\u03BD"'},Un=function(){return Y([])},Mn="zero",Hn={type:"literal",value:"zero",description:'"zero"'},Bn="0",Dn={type:"literal",value:"0",description:'"0"'},Jn={type:"other",description:"spaces"},Kn=/^[ \n\t]/,Yn={type:"class",value:"[ \\n\\t]",description:"[ \\n\\t]"},Qn={type:"other",description:"space"},Vn={type:"other",description:"comment"},Xn="/*",te={type:"literal",value:"/*",description:'"/*"'},ne="*/",ee={type:"literal",value:"*/",description:'"*/"'},re={type:"any",description:"any character"},oe="//",ie={type:"literal",
value:"//",description:'"//"'},ae=/^[^\n]/,se={type:"class",value:"[^\\n]",description:"[^\\n]"},ce="\n",ue={type:"literal",value:"\n",description:'"\\n"'},le=0,pe=0,fe=[{line:1,column:1,seenCR:!1}],he=0,de=[],ve=0,ge;if("startRule"in nt){if(!(nt.startRule in ot))throw new Error("Can't start parsing from rule \""+nt.startRule+'".');it=ot[nt.startRule]}var me=!0;if(ge=it(),ge!==rt&&le===t.length)return ge;throw ge!==rt&&le<t.length&&c({type:"end",description:"end of input"}),u(null,de,he<t.length?t.charAt(he):null,he<t.length?s(he,he+1):s(he,he))}return t(n,Error),{SyntaxError:n,parse:e}}(),function(){function lookup(t){for(var n=arguments.length-1;!(1>n||t in arguments[n]);)n--;if(1>n)throw Error("Unknown name "+t);return arguments[n][t]}function compile(txt){var ast=txt;"string"==typeof ast&&(ast=parsePi.parse(txt));var prog={defs:{},init:[],sourceCode:txt},defs=ast.defs,cdefs=[];for(var pvar in defs){var comp=defs[pvar].body.components,ccomp=[],fargs={};for(var n in defs[pvar].args)fargs[defs[pvar].args[n]]="x"+n;for(var c in comp)if("input"===comp[c].action.type){var aargs={};for(var n in comp[c].action.args)aargs[comp[c].action.args[n]]="y"+n;var cinp="Receive("+fargs[comp[c].action.channel]+", ";cinp+="function("+comp[c].action.args.map(function(t,n){return"y"+n}).join(",")+") {\n";var procs,cargs={};if("New"===comp[c].cont.type){var ns=comp[c].cont.names;for(var n in ns)cargs[ns[n].name]="z"+n,cinp+="var z"+n+' = new Channel("'+ns[n].name+'");\n';procs=comp[c].cont.proc.components}else{if("Parall"!==comp[c].cont.type)throw Error("Expecting a normalised process! line: "+comp[c].action.loc.start.line);procs=comp[c].cont.components}var cconts=[];for(var pc in procs){if("PiCall"!==procs[pc].type)throw Error("Unexpected "+procs[pc].type+" at line "+procs[pc].loc.start.line);var callargs=procs[pc].args;for(var a in callargs)callargs[a]=lookup(callargs[a],fargs,aargs,cargs);cconts.push("ProcCall('"+procs[pc].pvar+"', ["+callargs.join(",")+"])")}cinp+="return [\n"+cconts.join(",")+"\n];})",ccomp.push(cinp)}else if("output"===comp[c].action.type){var cout="Send("+fargs[comp[c].action.channel]+", [",aargs=[];for(var n in comp[c].action.args)aargs.push(lookup(comp[c].action.args[n],fargs));if(cout+=aargs.join(",")+"]",comp[c].cont&&("Parall"!==comp[c].cont.type||comp[c].cont.components.length>0)){cout+=", function() {\n";var procs,cargs={};if("New"===comp[c].cont.type){var ns=comp[c].cont.names;for(var n in ns)cargs[ns[n].name]="z"+n,cout+="var z"+n+' = new Channel("'+ns[n].name+'");\n';procs=comp[c].cont.proc.components}else{if("Parall"!==comp[c].cont.type)throw Error("Expecting a normalised process! line: "+comp[c].action.loc.start.line);procs=comp[c].cont.components}var cconts=[];for(var pc in procs){if("PiCall"!==procs[pc].type)throw Error("Unexpected "+procs[pc].type+" at line "+procs[pc].loc.start.line);var callargs=procs[pc].args;for(var a in callargs)callargs[a]=lookup(callargs[a],fargs,cargs);cconts.push("ProcCall('"+procs[pc].pvar+"', ["+callargs.join(",")+"])")}cout+="return [\n"+cconts.join(",")+"\n];}"}cout+=")",ccomp.push(cout)}else if("tau"===comp[c].action.type){var cout="Tau(";if(comp[c].cont&&("Parall"!==comp[c].cont.type||comp[c].cont.components.length>0)){cout+="function() {\n";var procs,cargs={};if("New"===comp[c].cont.type){var ns=comp[c].cont.names;for(var n in ns)cargs[ns[n].name]="z"+n,cout+="var z"+n+' = new Channel("'+ns[n].name+'");\n';procs=comp[c].cont.proc.components}else{if("Parall"!==comp[c].cont.type)throw Error("Expecting a normalised process! line: "+comp[c].action.loc.start.line);procs=comp[c].cont.components}var cconts=[];for(var pc in procs){if("PiCall"!==procs[pc].type)throw Error("Unexpected "+procs[pc].type+" at line "+procs[pc].loc.start.line);var callargs=procs[pc].args;for(var a in callargs)callargs[a]=lookup(callargs[a],fargs,cargs);cconts.push("ProcCall('"+procs[pc].pvar+"', ["+callargs.join(",")+"]"+(procs[pc].heir?", true":"")+")")}cout+="return [\n"+cconts.join(",")+"\n];}"}cout+=")",ccomp.push(cout)}var alt="function(";alt+=defs[pvar].args.map(function(t,n){return"x"+n}).join(","),alt+="){return Alt([\n",alt+=ccomp.join(",\n"),alt+="\n]);}",cdefs.push("'"+pvar+"': "+alt)}prog.init=collect_procs(ast.start);var str_defs="PiDefs({"+cdefs.join(",\n")+"})";return prog.defs=eval(str_defs),prog}function collect_procs(t,n,e){if(n=n||{},e=e||{},"New"===t.type){var r=$.extend({},e);for(var o in t.names)r[t.names[o].name]=new Channel(t.names[o].name);return collect_procs(t.proc,n,r)}if("Parall"===t.type){var i=[];for(var a in t.components){var s=collect_procs(t.components[a],n,e);i=i.concat(s)}return i}if("PiCall"===t.type){var c=t.args;for(var u in c)try{c[u]=lookup(c[u],n,e)}catch(l){n[c[u]]=new Channel(c[u],!0),c[u]=n[c[u]]}var p=void 0;return t.fixed&&(p={x:t.x,y:t.y,fixed:!0}),[ProcCall(t.pvar,c,p)]}if("Alt"===t.type)throw Error("Sums not supported at top level. Wrap them in definitions.")}function stxerr(t,n){var e=new Error(t);return e.location=n,e}function validate_syntax(t){for(var n in t.defs){var e=t.defs[n].body;if("Alt"!==e.type)throw stxerr("Normalise your definitions! Your definition for "+n+" does not have a sum at the top level.",e.loc);for(var r in e.components)check_free_names(e.components[r],t.defs[n].args)}}function check_free_names(t,n){if("New"===t.type)check_free_names(t.proc,n.concat(t.names.map(function(t){return t.name})));else if("PiCall"===t.type){for(var e in t.args)if(n.indexOf(t.args[e])<0)throw stxerr("Name '"+t.args[e]+"' out of scope.",t.loc)}else if("Parall"===t.type)for(var e in t.components)check_free_names(t.components[e],n);else{if("Alt"===t.type)throw stxerr("Normalize your code! Sums only allowed at the top-level of a definition!",t.loc);if(void 0!==t.action)if("tau"===t.action.type)check_free_names(t.cont,n);else{if(n.indexOf(t.action.channel)<0)throw stxerr("Name '"+t.action.channel+"' out of scope.",t.loc);if("input"===t.action.type)check_free_names(t.cont,n.concat(t.action.args));else if("output"===t.action.type){for(var e in t.args)if(n.indexOf(t.args[e])<0)throw stxerr("Name '"+t.args[e]+"' out of scope.",t.loc);check_free_names(t.cont,n)}}}}window.parsePi.compile=compile,window.parsePi.validate=validate_syntax,window.parsePi.compileAndCheck=function(t){return t=parsePi.parse(t),validate_syntax(t),compile(t)}}();var gistUrlPattern=/^(https?:\/\/)?gist\.github\.com.*\/([a-zA-Z0-9]*)$/,Stargazer=function(){function t(e,a,s){function c(){$(d.node()).height(function(){return $(this).parent().innerHeight()}).width(function(){return $(this).parent().innerWidth()}).attr("width",function(){return $(this).width()}).attr("height",function(){return $(this).height()}),l&&l.translate([d.attr("width")/2,d.attr("height")/2])}function u(){n(h.node())?k.freeze():k.unfreeze()}if(!(this instanceof t))return new t(e,a,s);s=$.extend({zoom:1,delay:500,gravity:!0,showLabels:!0,playOnLoad:!1,autoFreeze:!0,autoResize:!0},s);var l,p=+s.zoom,f=s.palette?{palette:s.palette}:void 0,h=d3.select(e);h.selectAll(o).remove(),h.append("svg").classed(r,!0);var d=h.select(o);h.datum(this),void 0===a&&(a="0");var v=a,g=parsePi.compileAndCheck(v);l=PiCalcSimulation(d,g,f),l.scale(p);for(var m=10;m>0;--m)l.layout().tick();this.simulator=function(){return l},this.program=function(t){return void 0===t?v:(g=parsePi.compileAndCheck(t),v=t,this.reset(),void 0)},this.resizeCanvas=c,s.autoResize&&($(h.node()).on("div-resize",c),c()),this.gravity=function(t){return void 0===t?l.layout().gravity()>.05:void(t?l.layout().gravity(.2).charge(-400).start():l.layout().gravity(1e-5).charge(-30).start())},this.gravity(s.gravity);var y=function(){return l.next(l.randomStrategy),this};this.step=y;var x=s.delay,C,A=!1,w=!1;this.running=function(){return A},this.delay=function(){return x};var b=$("<div class='controls'></div>").appendTo(h.node()),P=$("<div class='control play'></div>").click(function(){A?k.pause():k.play()}).appendTo(b),_=$("<div class='control open'></div>").click(function(){k.pause(),window.open(i+(s.link||"?program="+encodeURIComponent(v)))}).appendTo(b),z=$("<div class='control reset'></div>").click(function(){k.reset()}).appendTo(b);this.play=function(t){return!A||void 0!==t&&+t!==x?(void 0!==t&&(x=+t),clearInterval(C),w||(C=setInterval(y,x)),P.removeClass("play").addClass("pause"),A=!0,this):this},this.delay=function(t){return void 0===t?x:(A?this.play(t):x=+t,this)},this.pause=function(){return clearInterval(C),P.removeClass("pause").addClass("play"),A=!1,this},this.freeze=function(){return w=!0,clearInterval(C),this},this.unfreeze=function(){return A&&w&&(C=setInterval(y,x)),w=!1,this},this.reset=function(){return this.pause(),d.selectAll("*").remove(),l=PiCalcSimulation(d,g,f),l.scale(p),this},s.playOnLoad&&this.play();var k=this;this.autoFreeze=u,s.autoFreeze&&$(h.node()).on("view-change",u),this.showLabels=function(t){return 0===arguments.length?d.classed("labels"):(d.classed("labels",t),this)},this.toggleLabels=function(){return d.classed("labels",!d.classed("labels")),this},this.showGlobals=function(t){return 0===arguments.length?d.classed("globals"):(d.classed("globals",t),this)},this.toggleGlobals=function(){return d.classed("globals",!d.classed("globals")),this},s.showLabels&&this.showLabels(s.showLabels),s.showGlobals&&this.showLabels(s.showGlobals)}function n(t){var n=t.getBoundingClientRect(),e=$(window),r=e.height(),o=e.width();return n.right<0||n.bottom<0||n.top>r||n.left>o}var e=/^(.*)_(\d*)$/,r="stargazer-viz",o="svg."+r,i="http://stargazer.emanueledosualdo.com";return t}();$(function(){function t(t,n){var e;return function(){clearTimeout(e),e=setTimeout(t,n||250)}}var n=function(){function t(t,n){t.name=t.name||n["default"],t.sourceCode=n.programs[t.name].sourceCode,t.options=$.extend({},n.programs[t.name].options,t.options),t.options.link="?gist="+encodeURIComponent(t.sourceId)+"#"+t.name}function n(n,r){var o={name:void 0,sourceCode:"0",source:"none",sourceId:"",options:{}};o.options.gravity="false"!==n.attr("data-gravity");var i=n.attr("data-palette");if(i&&(o.options.palette={},i.split(";").map(function(t){var n=t.split(":");return[n[0].trim(),n[1].trim()]}).each(function(t){o.options.palette[t[0]]=t[1]})),o.options.showLabels="true"===n.attr("data-labels")||n.hasClass("labels"),o.options.showGlobals="true"===n.attr("data-globals")||n.hasClass("globals"),o.options.playOnLoad="true"===n.attr("data-play-on-load"),o.options.delay=n.attr("data-delay"),o.options.zoom=n.attr("data-zoom"),o.name=n.attr("data-program"),n.attr("data-gist")){if(o.source="gist",o.sourceId=n.attr("data-gist"),!(o.sourceId in e))return suiteFromGist(o.sourceId,function(i){return i&&i.successful?(e[o.sourceId]=i,t(o,i),r(o)):void n.addClass("error")});t(o,e[o.sourceId])}else n.find('script[type="text/x-stargazer"]').size()>0?(o.source="inline-script",o.sourceCode=n.find('script[type="text/x-stargazer"]').text()):$('script[type="text/x-stargazer"]#'+o.name).size()>0&&(o.source="script",o.sourceCode=$('script[type="text/x-stargazer"]#'+o.name).text());setTimeout(function(){return r(o)},0)}var e={};return n}();$("div.stargazer").each(function(t){var e=$(this),r=this;e.addClass("loading").removeClass("error"),n(e,function(t){e.removeClass("loading");try{Stargazer(r,t.sourceCode,t.options)}catch(n){e.addClass("program error")}})}),$(window).resize(t(function(){$("div.stargazer").trigger("div-resize")})),$(window).scroll(t(function(){$("div.stargazer").trigger("view-change")}))});